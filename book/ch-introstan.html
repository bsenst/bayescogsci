<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Introduction to the probabilistic programming language Stan | An Introduction to Bayesian Data Analysis for Cognitive Science</title>
  <meta name="description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Introduction to the probabilistic programming language Stan | An Introduction to Bayesian Data Analysis for Cognitive Science" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://vasishth.github.io/Bayes_CogSci//images/temporarycover.jpg" />
  <meta property="og:description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="github-repo" content="https://github.com/vasishth/Bayes_CogSci" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Introduction to the probabilistic programming language Stan | An Introduction to Bayesian Data Analysis for Cognitive Science" />
  
  <meta name="twitter:description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="twitter:image" content="https://vasishth.github.io/Bayes_CogSci//images/temporarycover.jpg" />

<meta name="author" content="Bruno Nicenboim, Daniel Schad, and Shravan Vasishth" />


<meta name="date" content="2022-09-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-coding2x2.html"/>
<link rel="next" href="ch-complexstan.html"/>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>
<script>
// FOLD code from 
// https://github.com/bblodfon/rtemps/blob/master/docs/bookdown-lite/hide_code.html
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Bayesian Data Analysis for Cognitive Science (DRAFT)</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-is-this-book-for"><i class="fa fa-check"></i>Who is this book for?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#developing-the-right-mindset-for-this-book"><i class="fa fa-check"></i>Developing the right mindset for this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-read-this-book"><i class="fa fa-check"></i>How to read this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-read-this-book-anyway"><i class="fa fa-check"></i>Why read this book anyway?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#some-conventions-used-in-this-book"><i class="fa fa-check"></i>Some conventions used in this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#online-materials"><i class="fa fa-check"></i>Online materials</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-needed"><i class="fa fa-check"></i>Software needed</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="about-the-authors.html"><a href="about-the-authors.html"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="part"><span><b>I Foundational ideas</b></span></li>
<li class="chapter" data-level="1" data-path="ch-intro.html"><a href="ch-intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="ch-intro.html"><a href="ch-intro.html#introprob"><i class="fa fa-check"></i><b>1.1</b> Probability</a></li>
<li class="chapter" data-level="1.2" data-path="ch-intro.html"><a href="ch-intro.html#condprob"><i class="fa fa-check"></i><b>1.2</b> Conditional probability</a></li>
<li class="chapter" data-level="1.3" data-path="ch-intro.html"><a href="ch-intro.html#the-law-of-total-probability"><i class="fa fa-check"></i><b>1.3</b> The law of total probability</a></li>
<li class="chapter" data-level="1.4" data-path="ch-intro.html"><a href="ch-intro.html#sec-binomialcloze"><i class="fa fa-check"></i><b>1.4</b> Discrete random variables: An example using the binomial distribution</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="ch-intro.html"><a href="ch-intro.html#the-mean-and-variance-of-the-binomial-distribution"><i class="fa fa-check"></i><b>1.4.1</b> The mean and variance of the binomial distribution</a></li>
<li class="chapter" data-level="1.4.2" data-path="ch-intro.html"><a href="ch-intro.html#what-information-does-a-probability-distribution-provide"><i class="fa fa-check"></i><b>1.4.2</b> What information does a probability distribution provide?</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="ch-intro.html"><a href="ch-intro.html#continuous-random-variables-an-example-using-the-normal-distribution"><i class="fa fa-check"></i><b>1.5</b> Continuous random variables: An example using the normal distribution</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="ch-intro.html"><a href="ch-intro.html#an-important-distinction-probability-vs.-density-in-a-continuous-random-variable"><i class="fa fa-check"></i><b>1.5.1</b> An important distinction: probability vs. density in a continuous random variable</a></li>
<li class="chapter" data-level="1.5.2" data-path="ch-intro.html"><a href="ch-intro.html#truncating-a-normal-distribution"><i class="fa fa-check"></i><b>1.5.2</b> Truncating a normal distribution</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="ch-intro.html"><a href="ch-intro.html#bivariate-and-multivariate-distributions"><i class="fa fa-check"></i><b>1.6</b> Bivariate and multivariate distributions</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="ch-intro.html"><a href="ch-intro.html#example-1-discrete-bivariate-distributions"><i class="fa fa-check"></i><b>1.6.1</b> Example 1: Discrete bivariate distributions</a></li>
<li class="chapter" data-level="1.6.2" data-path="ch-intro.html"><a href="ch-intro.html#sec-contbivar"><i class="fa fa-check"></i><b>1.6.2</b> Example 2: Continuous bivariate distributions</a></li>
<li class="chapter" data-level="1.6.3" data-path="ch-intro.html"><a href="ch-intro.html#sec-generatebivariatedata"><i class="fa fa-check"></i><b>1.6.3</b> Generate simulated bivariate (multivariate) data</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="ch-intro.html"><a href="ch-intro.html#sec-marginal"><i class="fa fa-check"></i><b>1.7</b> An important concept: The marginal likelihood (integrating out a parameter)</a></li>
<li class="chapter" data-level="1.8" data-path="ch-intro.html"><a href="ch-intro.html#summary-of-useful-r-functions-relating-to-distributions"><i class="fa fa-check"></i><b>1.8</b> Summary of useful R functions relating to distributions</a></li>
<li class="chapter" data-level="1.9" data-path="ch-intro.html"><a href="ch-intro.html#summary"><i class="fa fa-check"></i><b>1.9</b> Summary</a></li>
<li class="chapter" data-level="1.10" data-path="ch-intro.html"><a href="ch-intro.html#further-reading"><i class="fa fa-check"></i><b>1.10</b> Further reading</a></li>
<li class="chapter" data-level="1.11" data-path="ch-intro.html"><a href="ch-intro.html#sec-Foundationsexercises"><i class="fa fa-check"></i><b>1.11</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ch-introBDA.html"><a href="ch-introBDA.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian data analysis</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-introBDA.html"><a href="ch-introBDA.html#bayes-rule"><i class="fa fa-check"></i><b>2.1</b> Bayes’ rule</a></li>
<li class="chapter" data-level="2.2" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-analytical"><i class="fa fa-check"></i><b>2.2</b> Deriving the posterior using Bayes’ rule: An analytical example</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="ch-introBDA.html"><a href="ch-introBDA.html#choosing-a-likelihood"><i class="fa fa-check"></i><b>2.2.1</b> Choosing a likelihood</a></li>
<li class="chapter" data-level="2.2.2" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-choosepriortheta"><i class="fa fa-check"></i><b>2.2.2</b> Choosing a prior for <span class="math inline">\(\theta\)</span></a></li>
<li class="chapter" data-level="2.2.3" data-path="ch-introBDA.html"><a href="ch-introBDA.html#using-bayes-rule-to-compute-the-posterior-pthetank"><i class="fa fa-check"></i><b>2.2.3</b> Using Bayes’ rule to compute the posterior <span class="math inline">\(p(\theta|n,k)\)</span></a></li>
<li class="chapter" data-level="2.2.4" data-path="ch-introBDA.html"><a href="ch-introBDA.html#summary-of-the-procedure"><i class="fa fa-check"></i><b>2.2.4</b> Summary of the procedure</a></li>
<li class="chapter" data-level="2.2.5" data-path="ch-introBDA.html"><a href="ch-introBDA.html#visualizing-the-prior-likelihood-and-the-posterior"><i class="fa fa-check"></i><b>2.2.5</b> Visualizing the prior, likelihood, and the posterior</a></li>
<li class="chapter" data-level="2.2.6" data-path="ch-introBDA.html"><a href="ch-introBDA.html#the-posterior-distribution-is-a-compromise-between-the-prior-and-the-likelihood"><i class="fa fa-check"></i><b>2.2.6</b> The posterior distribution is a compromise between the prior and the likelihood</a></li>
<li class="chapter" data-level="2.2.7" data-path="ch-introBDA.html"><a href="ch-introBDA.html#incremental-knowledge-gain-using-prior-knowledge"><i class="fa fa-check"></i><b>2.2.7</b> Incremental knowledge gain using prior knowledge</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="ch-introBDA.html"><a href="ch-introBDA.html#summary-1"><i class="fa fa-check"></i><b>2.3</b> Summary</a></li>
<li class="chapter" data-level="2.4" data-path="ch-introBDA.html"><a href="ch-introBDA.html#further-reading-1"><i class="fa fa-check"></i><b>2.4</b> Further reading</a></li>
<li class="chapter" data-level="2.5" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-BDAexercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Regression models with brms</b></span></li>
<li class="chapter" data-level="3" data-path="ch-compbda.html"><a href="ch-compbda.html"><i class="fa fa-check"></i><b>3</b> Computational Bayesian data analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-sampling"><i class="fa fa-check"></i><b>3.1</b> Deriving the posterior through sampling</a></li>
<li class="chapter" data-level="3.2" data-path="ch-compbda.html"><a href="ch-compbda.html#bayesian-regression-models-using-stan-brms"><i class="fa fa-check"></i><b>3.2</b> Bayesian Regression Models using Stan: brms</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-simplenormal"><i class="fa fa-check"></i><b>3.2.1</b> A simple linear model: A single subject pressing a button repeatedly</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-priorpred"><i class="fa fa-check"></i><b>3.3</b> Prior predictive distribution</a></li>
<li class="chapter" data-level="3.4" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-sensitivity"><i class="fa fa-check"></i><b>3.4</b> The influence of priors: sensitivity analysis</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="ch-compbda.html"><a href="ch-compbda.html#flat-uninformative-priors"><i class="fa fa-check"></i><b>3.4.1</b> Flat, uninformative priors</a></li>
<li class="chapter" data-level="3.4.2" data-path="ch-compbda.html"><a href="ch-compbda.html#regularizing-priors"><i class="fa fa-check"></i><b>3.4.2</b> Regularizing priors</a></li>
<li class="chapter" data-level="3.4.3" data-path="ch-compbda.html"><a href="ch-compbda.html#principled-priors"><i class="fa fa-check"></i><b>3.4.3</b> Principled priors</a></li>
<li class="chapter" data-level="3.4.4" data-path="ch-compbda.html"><a href="ch-compbda.html#informative-priors"><i class="fa fa-check"></i><b>3.4.4</b> Informative priors</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-revisit"><i class="fa fa-check"></i><b>3.5</b> Revisiting the button-pressing example with different priors</a></li>
<li class="chapter" data-level="3.6" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-ppd"><i class="fa fa-check"></i><b>3.6</b> Posterior predictive distribution</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="ch-compbda.html"><a href="ch-compbda.html#comparing-different-likelihoods"><i class="fa fa-check"></i><b>3.6.1</b> Comparing different likelihoods</a></li>
<li class="chapter" data-level="3.6.2" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-lnfirst"><i class="fa fa-check"></i><b>3.6.2</b> The log-normal likelihood</a></li>
<li class="chapter" data-level="3.6.3" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-lognormal"><i class="fa fa-check"></i><b>3.6.3</b> Re-fitting a single subject pressing a button repeatedly with a log-normal likelihood</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="ch-compbda.html"><a href="ch-compbda.html#list-of-the-most-important-commands"><i class="fa fa-check"></i><b>3.7</b> List of the most important commands</a></li>
<li class="chapter" data-level="3.8" data-path="ch-compbda.html"><a href="ch-compbda.html#summary-2"><i class="fa fa-check"></i><b>3.8</b> Summary</a></li>
<li class="chapter" data-level="3.9" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-ch3furtherreading"><i class="fa fa-check"></i><b>3.9</b> Further reading</a></li>
<li class="chapter" data-level="3.10" data-path="ch-compbda.html"><a href="ch-compbda.html#ex:compbda"><i class="fa fa-check"></i><b>3.10</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-reg.html"><a href="ch-reg.html"><i class="fa fa-check"></i><b>4</b> Bayesian regression models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-reg.html"><a href="ch-reg.html#sec-pupil"><i class="fa fa-check"></i><b>4.1</b> A first linear regression: Does attentional load affect pupil size?</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-reg.html"><a href="ch-reg.html#likelihood-and-priors"><i class="fa fa-check"></i><b>4.1.1</b> Likelihood and priors</a></li>
<li class="chapter" data-level="4.1.2" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model"><i class="fa fa-check"></i><b>4.1.2</b> The <code>brms</code> model</a></li>
<li class="chapter" data-level="4.1.3" data-path="ch-reg.html"><a href="ch-reg.html#how-to-communicate-the-results"><i class="fa fa-check"></i><b>4.1.3</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.1.4" data-path="ch-reg.html"><a href="ch-reg.html#sec-pupiladq"><i class="fa fa-check"></i><b>4.1.4</b> Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-reg.html"><a href="ch-reg.html#sec-trial"><i class="fa fa-check"></i><b>4.2</b> Log-normal model: Does trial affect response times?</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-reg.html"><a href="ch-reg.html#likelihood-and-priors-for-the-log-normal-model"><i class="fa fa-check"></i><b>4.2.1</b> Likelihood and priors for the log-normal model</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model-1"><i class="fa fa-check"></i><b>4.2.2</b> The <code>brms</code> model</a></li>
<li class="chapter" data-level="4.2.3" data-path="ch-reg.html"><a href="ch-reg.html#how-to-communicate-the-results-1"><i class="fa fa-check"></i><b>4.2.3</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.2.4" data-path="ch-reg.html"><a href="ch-reg.html#descriptive-adequacy"><i class="fa fa-check"></i><b>4.2.4</b> Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-reg.html"><a href="ch-reg.html#sec-logistic"><i class="fa fa-check"></i><b>4.3</b> Logistic regression: Does set size affect free recall?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-reg.html"><a href="ch-reg.html#the-likelihood-for-the-logistic-regression-model"><i class="fa fa-check"></i><b>4.3.1</b> The likelihood for the logistic regression model</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-reg.html"><a href="ch-reg.html#sec-priorslogisticregression"><i class="fa fa-check"></i><b>4.3.2</b> Priors for the logistic regression</a></li>
<li class="chapter" data-level="4.3.3" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model-2"><i class="fa fa-check"></i><b>4.3.3</b> The <code>brms</code> model</a></li>
<li class="chapter" data-level="4.3.4" data-path="ch-reg.html"><a href="ch-reg.html#sec-comlogis"><i class="fa fa-check"></i><b>4.3.4</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.3.5" data-path="ch-reg.html"><a href="ch-reg.html#descriptive-adequacy-1"><i class="fa fa-check"></i><b>4.3.5</b> Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="ch-reg.html"><a href="ch-reg.html#summary-3"><i class="fa fa-check"></i><b>4.4</b> Summary</a></li>
<li class="chapter" data-level="4.5" data-path="ch-reg.html"><a href="ch-reg.html#sec-ch4furtherreading"><i class="fa fa-check"></i><b>4.5</b> Further reading</a></li>
<li class="chapter" data-level="4.6" data-path="ch-reg.html"><a href="ch-reg.html#sec-LMexercises"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html"><i class="fa fa-check"></i><b>5</b> Bayesian hierarchical models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#exchangeability-and-hierarchical-models"><i class="fa fa-check"></i><b>5.1</b> Exchangeability and hierarchical models</a></li>
<li class="chapter" data-level="5.2" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-N400hierarchical"><i class="fa fa-check"></i><b>5.2</b> A hierarchical model with a normal likelihood: The N400 effect</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-Mcp"><i class="fa fa-check"></i><b>5.2.1</b> Complete pooling model (<span class="math inline">\(M_{cp}\)</span>)</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#no-pooling-model-m_np"><i class="fa fa-check"></i><b>5.2.2</b> No pooling model (<span class="math inline">\(M_{np}\)</span>)</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-uncorrelated"><i class="fa fa-check"></i><b>5.2.3</b> Varying intercepts and varying slopes model (<span class="math inline">\(M_{v}\)</span>)</a></li>
<li class="chapter" data-level="5.2.4" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-mcvivs"><i class="fa fa-check"></i><b>5.2.4</b> Correlated varying intercept varying slopes model (<span class="math inline">\(M_{h}\)</span>)</a></li>
<li class="chapter" data-level="5.2.5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-sih"><i class="fa fa-check"></i><b>5.2.5</b> By-subjects and by-items correlated varying intercept varying slopes model (<span class="math inline">\(M_{sih}\)</span>)</a></li>
<li class="chapter" data-level="5.2.6" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-distrmodel"><i class="fa fa-check"></i><b>5.2.6</b> Beyond the maximal model–Distributional regression models</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-stroop"><i class="fa fa-check"></i><b>5.3</b> A hierarchical log-normal model: The Stroop effect</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#a-correlated-varying-intercept-varying-slopes-log-normal-model"><i class="fa fa-check"></i><b>5.3.1</b> A correlated varying intercept varying slopes log-normal model</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#why-fitting-a-bayesian-hierarchical-model-is-worth-the-effort"><i class="fa fa-check"></i><b>5.4</b> Why fitting a Bayesian hierarchical model is worth the effort</a></li>
<li class="chapter" data-level="5.5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#summary-4"><i class="fa fa-check"></i><b>5.5</b> Summary</a></li>
<li class="chapter" data-level="5.6" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#further-reading-2"><i class="fa fa-check"></i><b>5.6</b> Further reading</a></li>
<li class="chapter" data-level="5.7" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-HLMexercises"><i class="fa fa-check"></i><b>5.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-priors.html"><a href="ch-priors.html"><i class="fa fa-check"></i><b>6</b> The Art and Science of Prior Elicitation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-priors.html"><a href="ch-priors.html#sec-simpleexamplepriors"><i class="fa fa-check"></i><b>6.1</b> Eliciting priors from oneself for a self-paced reading study: A simple example</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-priors.html"><a href="ch-priors.html#an-example-english-relative-clauses"><i class="fa fa-check"></i><b>6.1.1</b> An example: English relative clauses</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-a-prior-for-the-intercept"><i class="fa fa-check"></i><b>6.1.2</b> Eliciting a prior for the intercept</a></li>
<li class="chapter" data-level="6.1.3" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-a-prior-for-the-slope"><i class="fa fa-check"></i><b>6.1.3</b> Eliciting a prior for the slope</a></li>
<li class="chapter" data-level="6.1.4" data-path="ch-priors.html"><a href="ch-priors.html#sec-varcomppriors"><i class="fa fa-check"></i><b>6.1.4</b> Eliciting priors for the variance components</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-priors-from-experts"><i class="fa fa-check"></i><b>6.2</b> Eliciting priors from experts</a></li>
<li class="chapter" data-level="6.3" data-path="ch-priors.html"><a href="ch-priors.html#deriving-priors-from-meta-analyses"><i class="fa fa-check"></i><b>6.3</b> Deriving priors from meta-analyses</a></li>
<li class="chapter" data-level="6.4" data-path="ch-priors.html"><a href="ch-priors.html#using-previous-experiments-posteriors-as-priors-for-a-new-study"><i class="fa fa-check"></i><b>6.4</b> Using previous experiments’ posteriors as priors for a new study</a></li>
<li class="chapter" data-level="6.5" data-path="ch-priors.html"><a href="ch-priors.html#summary-5"><i class="fa fa-check"></i><b>6.5</b> Summary</a></li>
<li class="chapter" data-level="6.6" data-path="ch-priors.html"><a href="ch-priors.html#further-reading-3"><i class="fa fa-check"></i><b>6.6</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-workflow.html"><a href="ch-workflow.html"><i class="fa fa-check"></i><b>7</b> Workflow</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-workflow.html"><a href="ch-workflow.html#model-building"><i class="fa fa-check"></i><b>7.1</b> Model building</a></li>
<li class="chapter" data-level="7.2" data-path="ch-workflow.html"><a href="ch-workflow.html#principled-questions-on-a-model"><i class="fa fa-check"></i><b>7.2</b> Principled questions on a model</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-workflow.html"><a href="ch-workflow.html#prior-predictive-checks-checking-consistency-with-domain-expertise"><i class="fa fa-check"></i><b>7.2.1</b> Prior predictive checks: Checking consistency with domain expertise</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-workflow.html"><a href="ch-workflow.html#computational-faithfulness-testing-for-correct-posterior-approximations"><i class="fa fa-check"></i><b>7.2.2</b> Computational faithfulness: Testing for correct posterior approximations</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-workflow.html"><a href="ch-workflow.html#model-sensitivity"><i class="fa fa-check"></i><b>7.2.3</b> Model sensitivity</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-workflow.html"><a href="ch-workflow.html#posterior-predictive-checks-does-the-model-adequately-capture-the-data"><i class="fa fa-check"></i><b>7.2.4</b> Posterior predictive checks: Does the model adequately capture the data?</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ch-workflow.html"><a href="ch-workflow.html#exemplary-data-analysis"><i class="fa fa-check"></i><b>7.3</b> Exemplary data analysis</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="ch-workflow.html"><a href="ch-workflow.html#prior-predictive-checks"><i class="fa fa-check"></i><b>7.3.1</b> Prior predictive checks</a></li>
<li class="chapter" data-level="7.3.2" data-path="ch-workflow.html"><a href="ch-workflow.html#adjusting-priors"><i class="fa fa-check"></i><b>7.3.2</b> Adjusting priors</a></li>
<li class="chapter" data-level="7.3.3" data-path="ch-workflow.html"><a href="ch-workflow.html#computational-faithfulness-and-model-sensitivity"><i class="fa fa-check"></i><b>7.3.3</b> Computational faithfulness and model sensitivity</a></li>
<li class="chapter" data-level="7.3.4" data-path="ch-workflow.html"><a href="ch-workflow.html#posterior-predictive-checks-model-adequacy"><i class="fa fa-check"></i><b>7.3.4</b> Posterior predictive checks: Model adequacy</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="ch-workflow.html"><a href="ch-workflow.html#summary-6"><i class="fa fa-check"></i><b>7.4</b> Summary</a></li>
<li class="chapter" data-level="7.5" data-path="ch-workflow.html"><a href="ch-workflow.html#further-reading-4"><i class="fa fa-check"></i><b>7.5</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-contr.html"><a href="ch-contr.html"><i class="fa fa-check"></i><b>8</b> Contrast coding</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-contr.html"><a href="ch-contr.html#basic-concepts-illustrated-using-a-two-level-factor"><i class="fa fa-check"></i><b>8.1</b> Basic concepts illustrated using a two-level factor</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="ch-contr.html"><a href="ch-contr.html#treatmentcontrasts"><i class="fa fa-check"></i><b>8.1.1</b> Default contrast coding: Treatment contrasts</a></li>
<li class="chapter" data-level="8.1.2" data-path="ch-contr.html"><a href="ch-contr.html#inverseMatrix"><i class="fa fa-check"></i><b>8.1.2</b> Defining comparisons</a></li>
<li class="chapter" data-level="8.1.3" data-path="ch-contr.html"><a href="ch-contr.html#effectcoding"><i class="fa fa-check"></i><b>8.1.3</b> Sum contrasts</a></li>
<li class="chapter" data-level="8.1.4" data-path="ch-contr.html"><a href="ch-contr.html#sec-cellMeans"><i class="fa fa-check"></i><b>8.1.4</b> Cell means parameterization and posterior comparisons</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="ch-contr.html"><a href="ch-contr.html#the-hypothesis-matrix-illustrated-with-a-three-level-factor"><i class="fa fa-check"></i><b>8.2</b> The hypothesis matrix illustrated with a three-level factor</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-contr.html"><a href="ch-contr.html#sumcontrasts"><i class="fa fa-check"></i><b>8.2.1</b> Sum contrasts</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-contr.html"><a href="ch-contr.html#the-hypothesis-matrix"><i class="fa fa-check"></i><b>8.2.2</b> The hypothesis matrix</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-contr.html"><a href="ch-contr.html#generating-contrasts-the-hypr-package"><i class="fa fa-check"></i><b>8.2.3</b> Generating contrasts: The <code>hypr</code> package</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="ch-contr.html"><a href="ch-contr.html#sec-4levelFactor"><i class="fa fa-check"></i><b>8.3</b> Other types of contrasts: illustration with a factor with four levels</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="ch-contr.html"><a href="ch-contr.html#repeatedcontrasts"><i class="fa fa-check"></i><b>8.3.1</b> Repeated contrasts</a></li>
<li class="chapter" data-level="8.3.2" data-path="ch-contr.html"><a href="ch-contr.html#helmertcontrasts"><i class="fa fa-check"></i><b>8.3.2</b> Helmert contrasts</a></li>
<li class="chapter" data-level="8.3.3" data-path="ch-contr.html"><a href="ch-contr.html#contrasts-in-linear-regression-analysis-the-design-or-model-matrix"><i class="fa fa-check"></i><b>8.3.3</b> Contrasts in linear regression analysis: The design or model matrix</a></li>
<li class="chapter" data-level="8.3.4" data-path="ch-contr.html"><a href="ch-contr.html#polynomialContrasts"><i class="fa fa-check"></i><b>8.3.4</b> Polynomial contrasts</a></li>
<li class="chapter" data-level="8.3.5" data-path="ch-contr.html"><a href="ch-contr.html#an-alternative-to-contrasts-monotonic-effects"><i class="fa fa-check"></i><b>8.3.5</b> An alternative to contrasts: monotonic effects</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="ch-contr.html"><a href="ch-contr.html#nonOrthogonal"><i class="fa fa-check"></i><b>8.4</b> What makes a good set of contrasts?</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="ch-contr.html"><a href="ch-contr.html#centered-contrasts"><i class="fa fa-check"></i><b>8.4.1</b> Centered contrasts</a></li>
<li class="chapter" data-level="8.4.2" data-path="ch-contr.html"><a href="ch-contr.html#orthogonal-contrasts"><i class="fa fa-check"></i><b>8.4.2</b> Orthogonal contrasts</a></li>
<li class="chapter" data-level="8.4.3" data-path="ch-contr.html"><a href="ch-contr.html#the-role-of-the-intercept-in-non-centered-contrasts"><i class="fa fa-check"></i><b>8.4.3</b> The role of the intercept in non-centered contrasts</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="ch-contr.html"><a href="ch-contr.html#computing-condition-means-from-estimated-contrasts"><i class="fa fa-check"></i><b>8.5</b> Computing condition means from estimated contrasts</a></li>
<li class="chapter" data-level="8.6" data-path="ch-contr.html"><a href="ch-contr.html#summary-7"><i class="fa fa-check"></i><b>8.6</b> Summary</a></li>
<li class="chapter" data-level="8.7" data-path="ch-contr.html"><a href="ch-contr.html#further-reading-5"><i class="fa fa-check"></i><b>8.7</b> Further reading</a></li>
<li class="chapter" data-level="8.8" data-path="ch-contr.html"><a href="ch-contr.html#sec-Contrastsexercises"><i class="fa fa-check"></i><b>8.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html"><i class="fa fa-check"></i><b>9</b> Contrast coding for designs with two predictor variables</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-MR-ANOVA"><i class="fa fa-check"></i><b>9.1</b> Contrast coding in a factorial <span class="math inline">\(2 \times 2\)</span> design</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#nestedEffects"><i class="fa fa-check"></i><b>9.1.1</b> Nested effects</a></li>
<li class="chapter" data-level="9.1.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#interactions-between-contrasts"><i class="fa fa-check"></i><b>9.1.2</b> Interactions between contrasts</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-contrast-covariate"><i class="fa fa-check"></i><b>9.2</b> One factor and one covariate</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#estimating-a-group-difference-and-controlling-for-a-covariate"><i class="fa fa-check"></i><b>9.2.1</b> Estimating a group difference and controlling for a covariate</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#estimating-differences-in-slopes"><i class="fa fa-check"></i><b>9.2.2</b> Estimating differences in slopes</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-interactions-NLM"><i class="fa fa-check"></i><b>9.3</b> Interactions in generalized linear models (with non-linear link functions) and non-linear models</a></li>
<li class="chapter" data-level="9.4" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#summary-8"><i class="fa fa-check"></i><b>9.4</b> Summary</a></li>
<li class="chapter" data-level="9.5" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#further-reading-6"><i class="fa fa-check"></i><b>9.5</b> Further reading</a></li>
<li class="chapter" data-level="9.6" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-Contrasts2x2exercises"><i class="fa fa-check"></i><b>9.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Advanced models with Stan</b></span></li>
<li class="chapter" data-level="10" data-path="ch-introstan.html"><a href="ch-introstan.html"><i class="fa fa-check"></i><b>10</b> Introduction to the probabilistic programming language Stan</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-introstan.html"><a href="ch-introstan.html#stan-syntax"><i class="fa fa-check"></i><b>10.1</b> Stan syntax</a></li>
<li class="chapter" data-level="10.2" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-firststan"><i class="fa fa-check"></i><b>10.2</b> A first simple example with Stan: Normal likelihood</a></li>
<li class="chapter" data-level="10.3" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-clozestan"><i class="fa fa-check"></i><b>10.3</b> Another simple example: Cloze probability with Stan with the binomial likelihood</a></li>
<li class="chapter" data-level="10.4" data-path="ch-introstan.html"><a href="ch-introstan.html#regression-models-in-stan"><i class="fa fa-check"></i><b>10.4</b> Regression models in Stan</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-pupilstan"><i class="fa fa-check"></i><b>10.4.1</b> A first linear regression in Stan: Does attentional load affect pupil size?</a></li>
<li class="chapter" data-level="10.4.2" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-interstan"><i class="fa fa-check"></i><b>10.4.2</b> Interactions in Stan: Does attentional load interact with trial number affecting pupil size?</a></li>
<li class="chapter" data-level="10.4.3" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-logisticstan"><i class="fa fa-check"></i><b>10.4.3</b> Logistic regression in Stan: Does set size and trial affect free recall?</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="ch-introstan.html"><a href="ch-introstan.html#summary-9"><i class="fa fa-check"></i><b>10.5</b> Summary</a></li>
<li class="chapter" data-level="10.6" data-path="ch-introstan.html"><a href="ch-introstan.html#further-reading-7"><i class="fa fa-check"></i><b>10.6</b> Further reading</a></li>
<li class="chapter" data-level="10.7" data-path="ch-introstan.html"><a href="ch-introstan.html#exercises"><i class="fa fa-check"></i><b>10.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-complexstan.html"><a href="ch-complexstan.html"><i class="fa fa-check"></i><b>11</b> Complex models and reparametrization</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-hierstan"><i class="fa fa-check"></i><b>11.1</b> Hierarchical models with Stan</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="ch-complexstan.html"><a href="ch-complexstan.html#varying-intercept-model-with-stan"><i class="fa fa-check"></i><b>11.1.1</b> Varying intercept model with Stan</a></li>
<li class="chapter" data-level="11.1.2" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-uncorrstan"><i class="fa fa-check"></i><b>11.1.2</b> Uncorrelated varying intercept and slopes model with Stan</a></li>
<li class="chapter" data-level="11.1.3" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-corrstan"><i class="fa fa-check"></i><b>11.1.3</b> Correlated varying intercept varying slopes model</a></li>
<li class="chapter" data-level="11.1.4" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-crosscorrstan"><i class="fa fa-check"></i><b>11.1.4</b> By-subject and by-items correlated varying intercept varying slopes model</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="ch-complexstan.html"><a href="ch-complexstan.html#summary-10"><i class="fa fa-check"></i><b>11.2</b> Summary</a></li>
<li class="chapter" data-level="11.3" data-path="ch-complexstan.html"><a href="ch-complexstan.html#further-reading-8"><i class="fa fa-check"></i><b>11.3</b> Further reading</a></li>
<li class="chapter" data-level="11.4" data-path="ch-complexstan.html"><a href="ch-complexstan.html#exercises-1"><i class="fa fa-check"></i><b>11.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-custom.html"><a href="ch-custom.html"><i class="fa fa-check"></i><b>12</b> Custom distributions in Stan</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-custom.html"><a href="ch-custom.html#sec-change"><i class="fa fa-check"></i><b>12.1</b> A change of variables with the reciprocal normal distribution</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-custom.html"><a href="ch-custom.html#scaling-a-probability-density-with-the-jacobian-adjustment"><i class="fa fa-check"></i><b>12.1.1</b> Scaling a probability density with the Jacobian adjustment</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-custom.html"><a href="ch-custom.html#sec-validSBC"><i class="fa fa-check"></i><b>12.2</b> Validation of a computed posterior distribution</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-custom.html"><a href="ch-custom.html#the-simulation-based-calibration-procedure"><i class="fa fa-check"></i><b>12.2.1</b> The simulation-based calibration procedure</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-custom.html"><a href="ch-custom.html#simulation-based-calibration-revealing-a-problem"><i class="fa fa-check"></i><b>12.2.2</b> Simulation-based calibration revealing a problem</a></li>
<li class="chapter" data-level="12.2.3" data-path="ch-custom.html"><a href="ch-custom.html#issues-and-limitation-of-simulation-based-calibration"><i class="fa fa-check"></i><b>12.2.3</b> Issues and limitation of simulation-based calibration</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-custom.html"><a href="ch-custom.html#a-custom-distribution-re-implementing-the-exponential-distribution-manually"><i class="fa fa-check"></i><b>12.3</b> A custom distribution: Re-implementing the exponential distribution manually</a></li>
<li class="chapter" data-level="12.4" data-path="ch-custom.html"><a href="ch-custom.html#summary-11"><i class="fa fa-check"></i><b>12.4</b> Summary</a></li>
<li class="chapter" data-level="12.5" data-path="ch-custom.html"><a href="ch-custom.html#further-reading-9"><i class="fa fa-check"></i><b>12.5</b> Further reading</a></li>
<li class="chapter" data-level="12.6" data-path="ch-custom.html"><a href="ch-custom.html#sec-customexercises"><i class="fa fa-check"></i><b>12.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>IV Other useful models</b></span></li>
<li class="chapter" data-level="13" data-path="ch-remame.html"><a href="ch-remame.html"><i class="fa fa-check"></i><b>13</b> Meta-analysis and measurement error models</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-remame.html"><a href="ch-remame.html#meta-analysis"><i class="fa fa-check"></i><b>13.1</b> Meta-analysis</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="ch-remame.html"><a href="ch-remame.html#a-meta-analysis-of-similarity-based-interference-in-sentence-comprehension"><i class="fa fa-check"></i><b>13.1.1</b> A meta-analysis of similarity-based interference in sentence comprehension</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="ch-remame.html"><a href="ch-remame.html#measurement-error-models"><i class="fa fa-check"></i><b>13.2</b> Measurement-error models</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="ch-remame.html"><a href="ch-remame.html#accounting-for-measurement-error-in-individual-differences-in-working-memory-capacity-and-reading-fluency"><i class="fa fa-check"></i><b>13.2.1</b> Accounting for measurement error in individual differences in working memory capacity and reading fluency</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="ch-remame.html"><a href="ch-remame.html#summary-12"><i class="fa fa-check"></i><b>13.3</b> Summary</a></li>
<li class="chapter" data-level="13.4" data-path="ch-remame.html"><a href="ch-remame.html#further-reading-10"><i class="fa fa-check"></i><b>13.4</b> Further reading</a></li>
<li class="chapter" data-level="13.5" data-path="ch-remame.html"><a href="ch-remame.html#sec-REMAMEexercises"><i class="fa fa-check"></i><b>13.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>V Model comparison and hypothesis testing</b></span></li>
<li class="chapter" data-level="14" data-path="ch-comparison.html"><a href="ch-comparison.html"><i class="fa fa-check"></i><b>14</b> Introduction to model comparison</a>
<ul>
<li class="chapter" data-level="14.1" data-path="ch-comparison.html"><a href="ch-comparison.html#further-reading-11"><i class="fa fa-check"></i><b>14.1</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="ch-bf.html"><a href="ch-bf.html"><i class="fa fa-check"></i><b>15</b> Bayes factors</a>
<ul>
<li class="chapter" data-level="15.1" data-path="ch-bf.html"><a href="ch-bf.html#hypothesis-testing-using-the-bayes-factor"><i class="fa fa-check"></i><b>15.1</b> Hypothesis testing using the Bayes factor</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="ch-bf.html"><a href="ch-bf.html#marginal-likelihood"><i class="fa fa-check"></i><b>15.1.1</b> Marginal likelihood</a></li>
<li class="chapter" data-level="15.1.2" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factor"><i class="fa fa-check"></i><b>15.1.2</b> Bayes factor</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-N400BF"><i class="fa fa-check"></i><b>15.2</b> Examining the N400 effect with Bayes factor</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="ch-bf.html"><a href="ch-bf.html#sensitivity-analysis-1"><i class="fa fa-check"></i><b>15.2.1</b> Sensitivity analysis</a></li>
<li class="chapter" data-level="15.2.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-BFnonnested"><i class="fa fa-check"></i><b>15.2.2</b> Non-nested models</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="ch-bf.html"><a href="ch-bf.html#the-influence-of-the-priors-on-bayes-factors-beyond-the-effect-of-interest"><i class="fa fa-check"></i><b>15.3</b> The influence of the priors on Bayes factors: beyond the effect of interest</a></li>
<li class="chapter" data-level="15.4" data-path="ch-bf.html"><a href="ch-bf.html#sec-stanBF"><i class="fa fa-check"></i><b>15.4</b> Bayes factor in Stan</a></li>
<li class="chapter" data-level="15.5" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factors-in-theory-and-in-practice"><i class="fa fa-check"></i><b>15.5</b> Bayes factors in theory and in practice</a>
<ul>
<li class="chapter" data-level="15.5.1" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factors-in-theory-stability-and-accuracy"><i class="fa fa-check"></i><b>15.5.1</b> Bayes factors in theory: Stability and accuracy</a></li>
<li class="chapter" data-level="15.5.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-BFvar"><i class="fa fa-check"></i><b>15.5.2</b> Bayes factors in practice: Variability with the data</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="ch-bf.html"><a href="ch-bf.html#summary-13"><i class="fa fa-check"></i><b>15.6</b> Summary</a></li>
<li class="chapter" data-level="15.7" data-path="ch-bf.html"><a href="ch-bf.html#further-reading-12"><i class="fa fa-check"></i><b>15.7</b> Further reading</a></li>
<li class="chapter" data-level="15.8" data-path="ch-bf.html"><a href="ch-bf.html#exercises-2"><i class="fa fa-check"></i><b>15.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="ch-cv.html"><a href="ch-cv.html"><i class="fa fa-check"></i><b>16</b> Cross-validation</a>
<ul>
<li class="chapter" data-level="16.1" data-path="ch-cv.html"><a href="ch-cv.html#expected-log-predictive-density-of-a-model"><i class="fa fa-check"></i><b>16.1</b> Expected log predictive density of a model</a></li>
<li class="chapter" data-level="16.2" data-path="ch-cv.html"><a href="ch-cv.html#k-fold-and-leave-one-out-cross-validation"><i class="fa fa-check"></i><b>16.2</b> K-fold and leave-one-out cross-validation</a></li>
<li class="chapter" data-level="16.3" data-path="ch-cv.html"><a href="ch-cv.html#testing-the-n400-effect-using-cross-validation"><i class="fa fa-check"></i><b>16.3</b> Testing the N400 effect using cross-validation</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-with-psis-loo"><i class="fa fa-check"></i><b>16.3.1</b> Cross-validation with PSIS-LOO</a></li>
<li class="chapter" data-level="16.3.2" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-with-k-fold"><i class="fa fa-check"></i><b>16.3.2</b> Cross-validation with K-fold</a></li>
<li class="chapter" data-level="16.3.3" data-path="ch-cv.html"><a href="ch-cv.html#leave-one-group-out-cross-validation"><i class="fa fa-check"></i><b>16.3.3</b> Leave-one-group-out cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="16.4" data-path="ch-cv.html"><a href="ch-cv.html#sec-logcv"><i class="fa fa-check"></i><b>16.4</b> Comparing different likelihoods with cross-validation</a></li>
<li class="chapter" data-level="16.5" data-path="ch-cv.html"><a href="ch-cv.html#issues-with-cross-validation"><i class="fa fa-check"></i><b>16.5</b> Issues with cross-validation</a></li>
<li class="chapter" data-level="16.6" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-in-stan"><i class="fa fa-check"></i><b>16.6</b> Cross-validation in Stan</a>
<ul>
<li class="chapter" data-level="16.6.1" data-path="ch-cv.html"><a href="ch-cv.html#psis-loo-cv-in-stan"><i class="fa fa-check"></i><b>16.6.1</b> PSIS-LOO-CV in Stan</a></li>
</ul></li>
<li class="chapter" data-level="16.7" data-path="ch-cv.html"><a href="ch-cv.html#summary-14"><i class="fa fa-check"></i><b>16.7</b> Summary</a></li>
<li class="chapter" data-level="16.8" data-path="ch-cv.html"><a href="ch-cv.html#further-reading-13"><i class="fa fa-check"></i><b>16.8</b> Further reading</a></li>
<li class="chapter" data-level="16.9" data-path="ch-cv.html"><a href="ch-cv.html#exercises-3"><i class="fa fa-check"></i><b>16.9</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>VI Computational cognitive modeling with Stan</b></span></li>
<li class="chapter" data-level="17" data-path="ch-cogmod.html"><a href="ch-cogmod.html"><i class="fa fa-check"></i><b>17</b> Introduction to computational cognitive modeling</a>
<ul>
<li class="chapter" data-level="17.1" data-path="ch-cogmod.html"><a href="ch-cogmod.html#further-reading-14"><i class="fa fa-check"></i><b>17.1</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="ch-MPT.html"><a href="ch-MPT.html"><i class="fa fa-check"></i><b>18</b> Multinomial processing trees</a>
<ul>
<li class="chapter" data-level="18.1" data-path="ch-MPT.html"><a href="ch-MPT.html#modeling-multiple-categorical-responses"><i class="fa fa-check"></i><b>18.1</b> Modeling multiple categorical responses</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-mult"><i class="fa fa-check"></i><b>18.1.1</b> A model for multiple responses using the multinomial likelihood</a></li>
<li class="chapter" data-level="18.1.2" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-cat"><i class="fa fa-check"></i><b>18.1.2</b> A model for multiple responses using the categorical distribution</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="ch-MPT.html"><a href="ch-MPT.html#modeling-picture-naming-abilities-in-aphasia-with-mpt-models"><i class="fa fa-check"></i><b>18.2</b> Modeling picture naming abilities in aphasia with MPT models</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="ch-MPT.html"><a href="ch-MPT.html#calculation-of-the-probabilities-in-the-mpt-branches"><i class="fa fa-check"></i><b>18.2.1</b> Calculation of the probabilities in the MPT branches</a></li>
<li class="chapter" data-level="18.2.2" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-mpt-data"><i class="fa fa-check"></i><b>18.2.2</b> A simple MPT model</a></li>
<li class="chapter" data-level="18.2.3" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-MPT-reg"><i class="fa fa-check"></i><b>18.2.3</b> An MPT assuming by-item variability</a></li>
<li class="chapter" data-level="18.2.4" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-MPT-h"><i class="fa fa-check"></i><b>18.2.4</b> A hierarchical MPT</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="ch-MPT.html"><a href="ch-MPT.html#further-reading-15"><i class="fa fa-check"></i><b>18.3</b> Further reading</a></li>
<li class="chapter" data-level="18.4" data-path="ch-MPT.html"><a href="ch-MPT.html#exercises-4"><i class="fa fa-check"></i><b>18.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="ch-mixture.html"><a href="ch-mixture.html"><i class="fa fa-check"></i><b>19</b> Mixture models</a>
<ul>
<li class="chapter" data-level="19.1" data-path="ch-mixture.html"><a href="ch-mixture.html#a-mixture-model-of-the-speed-accuracy-trade-off-the-fast-guess-model-account"><i class="fa fa-check"></i><b>19.1</b> A mixture model of the speed-accuracy trade-off: The fast-guess model account</a>
<ul>
<li class="chapter" data-level="19.1.1" data-path="ch-mixture.html"><a href="ch-mixture.html#the-global-motion-detection-task"><i class="fa fa-check"></i><b>19.1.1</b> The global motion detection task</a></li>
<li class="chapter" data-level="19.1.2" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-simplefastguess"><i class="fa fa-check"></i><b>19.1.2</b> A very simple implementation of the fast-guess model</a></li>
<li class="chapter" data-level="19.1.3" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-multmix"><i class="fa fa-check"></i><b>19.1.3</b> A multivariate implementation of the fast-guess model</a></li>
<li class="chapter" data-level="19.1.4" data-path="ch-mixture.html"><a href="ch-mixture.html#an-implementation-of-the-fast-guess-model-that-takes-instructions-into-account"><i class="fa fa-check"></i><b>19.1.4</b> An implementation of the fast-guess model that takes instructions into account</a></li>
<li class="chapter" data-level="19.1.5" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-fastguessh"><i class="fa fa-check"></i><b>19.1.5</b> A hierarchical implementation of the fast-guess model</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="ch-mixture.html"><a href="ch-mixture.html#summary-15"><i class="fa fa-check"></i><b>19.2</b> Summary</a></li>
<li class="chapter" data-level="19.3" data-path="ch-mixture.html"><a href="ch-mixture.html#further-reading-16"><i class="fa fa-check"></i><b>19.3</b> Further reading</a></li>
<li class="chapter" data-level="19.4" data-path="ch-mixture.html"><a href="ch-mixture.html#exercises-5"><i class="fa fa-check"></i><b>19.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html"><i class="fa fa-check"></i><b>20</b> A simple accumulator model to account for choice response time</a>
<ul>
<li class="chapter" data-level="20.1" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#modeling-a-lexical-decision-task"><i class="fa fa-check"></i><b>20.1</b> Modeling a lexical decision task</a>
<ul>
<li class="chapter" data-level="20.1.1" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-acccoding"><i class="fa fa-check"></i><b>20.1.1</b> Modeling the lexical decision task with the log-normal race model</a></li>
<li class="chapter" data-level="20.1.2" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-genaccum"><i class="fa fa-check"></i><b>20.1.2</b> A generative model for a race between accumulators</a></li>
<li class="chapter" data-level="20.1.3" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#fitting-the-log-normal-race-model"><i class="fa fa-check"></i><b>20.1.3</b> Fitting the log-normal race model</a></li>
<li class="chapter" data-level="20.1.4" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-lognormalh"><i class="fa fa-check"></i><b>20.1.4</b> A hierarchical implementation of the log-normal race model</a></li>
<li class="chapter" data-level="20.1.5" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-contaminant"><i class="fa fa-check"></i><b>20.1.5</b> Dealing with contaminant responses</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#posterior-predictive-check-with-the-quantile-probability-plots"><i class="fa fa-check"></i><b>20.2</b> Posterior predictive check with the quantile probability plots</a></li>
<li class="chapter" data-level="20.3" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#summary-16"><i class="fa fa-check"></i><b>20.3</b> Summary</a></li>
<li class="chapter" data-level="20.4" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#further-reading-17"><i class="fa fa-check"></i><b>20.4</b> Further reading</a></li>
<li class="chapter" data-level="20.5" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#exercises-6"><i class="fa fa-check"></i><b>20.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An Introduction to Bayesian Data Analysis for Cognitive Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-introstan" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Introduction to the probabilistic programming language Stan<a href="ch-introstan.html#ch-introstan" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Stan is a probabilistic programming language for statistical inference written in C++ that can be accessed through several interfaces (e.g., R, Python, Matlab, etc.). Stan uses an advanced dynamic Hamiltonian Monte Carlo algorithm <span class="citation">(<a href="#ref-betancourt2016identifying" role="doc-biblioref">Betancourt 2016</a>)</span> based on a variant of the No-U-Turn sampler <span class="citation">(known as NUTS: <a href="#ref-hoffmanNoUTurnSamplerAdaptively2014" role="doc-biblioref">Hoffman and Gelman 2014</a>)</span>, which is, in general, more efficient than the traditional Gibbs sampler used in other probabilistic languages such as (Win)BUGS <span class="citation">(<a href="#ref-lunn2000winbugs" role="doc-biblioref">D. J. Lunn et al. 2000</a>)</span> and JAGS <span class="citation">(<a href="#ref-plummer2016jags" role="doc-biblioref">Plummer 2016</a>)</span>. In this part of the book, we will focus on the package <code>rstan</code> <span class="citation">(<a href="#ref-R-rstan" role="doc-biblioref">Guo, Gabry, and Goodrich 2019</a>)</span> that integrates Stan <span class="citation">(<a href="#ref-carpenter2017stan" role="doc-biblioref">Carpenter et al. 2017</a>)</span> with R <span class="citation">(<a href="#ref-R-base" role="doc-biblioref">R Core Team 2019</a>)</span>.</p>
<p>In order to understand how to fit a model in Stan and the difficulties we might face, a minimal understanding of the Stan sampling algorithm is needed.
Stan takes advantage of the fact that the <em>shape</em> of the posterior distribution is perfectly determined by the priors and the likelihood we have defined, that is the unnormalized posterior distribution, the upper part of the Bayes rule (abbreviated as <span class="math inline">\(up\)</span>). This is because the denominator, or marginal likelihood, “only” constitutes a normalizing constant:</p>
<p><span class="math display" id="eq:bayesagain">\[\begin{equation}
p(\Theta|y) = \cfrac{ p(y|\Theta) \cdot p(\Theta) }{p(y)}
\tag{10.1}
\end{equation}\]</span></p>
<p><span class="math display" id="eq:bayesagain2">\[\begin{equation}
up(\Theta|y) = p(y|\Theta) \cdot p(\Theta)
\tag{10.2}
\end{equation}\]</span></p>
<p>Thus the unnormalized posterior is proportional to the posterior distribution:</p>
<p><span class="math display" id="eq:bayesagain3">\[\begin{equation}
up(\Theta|y) \propto p(\Theta|y)
\tag{10.3}
\end{equation}\]</span></p>
<p>(The notation <span class="math inline">\(up(\cdot)\)</span> that we are using here is not standard in statistics; we are using it only for pedagogical convenience.)</p>
<p>Stan sampler uses Hamiltonian dynamics and treats the vector of parameters, <span class="math inline">\(\Theta\)</span> (that could range from a vector containing a couple of parameters, e.g., <span class="math inline">\(&lt;\mu,\sigma&gt;\)</span>, to a vector of hundreds of parameters in hierarchical models), as the position of a frictionless particle that glides on the <em>negative logarithm of the unnormalized posterior</em>.
That means that high probability places are valleys and low probability places are peaks in this space.<a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a> However, Stan doesn’t just let the particle glide until the bottom of this space. If we let that happen, we would find the mode of the posterior distribution, rather than samples. Stan uses a complex algorithm to determine the weight of the particle and the momentum that we apply to it, as well as when to stop the particle trajectory to take a sample. Because we need to know the speed of this particle, Stan needs to be able to calculate the derivative of the log unnormalized posterior with respect to the parameters (recall that speed is the first derivative of position). This means that if the parameter space is differentiable (is relatively smooth, and does not have any break or angle) and if the parameters of the Stan algorithm are well adjusted–as should happen in the warm-up period–these samples are going to represent samples of the true posterior distribution. Bear in mind that the geometry of the posterior has a big influence on whether the algorithm will converge (fast) or not: If the space is very flat, because there isn’t much data and the priors are not informative, then the particle may need to glide for a long time before it gets to a high probability area; if there are several valleys (multimodality) the particle may never leave the vicinity of one of them; and if the space is funnel shaped, the particle may never explore the funnel. One of the reasons for the difficulties in exploring complicated spaces is that the continuous path of the “particle” is discretized and divided into steps, and the <em>step size</em> is optimized for the entire posterior space. In spaces that are too complex, such as a funnel, a step size might be too small to explore the wide part of the funnel, but too large to explore the narrow part; we will deal with this problem in section <a href="ch-complexstan.html#sec-uncorrstan">11.1.2</a>.</p>
<p>Although our following example assumes a vector of two parameters and thus a simple geometry, real world examples can easily have hundreds of parameters defining an unnormalized posterior space with hundreds of dimensions.</p>
<p>One question that might arise here is the following: Given that we already know the shape of the posterior, why do we need samples? After all, the posterior is just the unnormalized posterior multiplied by some number, the normalizing constant.</p>
<p>To make this discussion concrete, let’s say that we have a subject that participates in a memory test, and in each trial we get a noisy score from their true working memory score. We assume that at each trial, the score is elicited with normally distributed noise. If we want to estimate the score and how much the noise makes it vary from trial to trial, we are assuming a normal likelihood and we want to estimate its mean and standard deviation.</p>
<p>We will use simulated data produced by a normal distribution with a true mean of 3 and a true standard deviation of 10:</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb606-1"><a href="ch-introstan.html#cb606-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb606-2"><a href="ch-introstan.html#cb606-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Y)</span></code></pre></div>
<pre><code>## [1] -3.376 -0.906 11.568 -8.038 14.613  6.984</code></pre>
<p>As always, given our prior knowledge, we decide on priors. In this case, we use a log-normal prior for the standard deviation, <span class="math inline">\(\sigma\)</span>, since it can only be positive, but except for that, the prior distributions are quite arbitrary in this example.</p>
<p><span class="math display" id="eq:priorsdem">\[\begin{equation}
\begin{aligned}
\mu &amp;\sim \mathit{Normal}(0, 20)\\
\sigma &amp;\sim \mathit{LogNormal}(3, 1)
\end{aligned}
\tag{10.4}
\end{equation}\]</span></p>
<p>The unnormalized posterior will be the product of the likelihood of each data point times the prior for each parameter:</p>
<p><span class="math display" id="eq:up">\[\begin{equation}
up(\mu, \sigma |y) = \prod_n^{100} \mathit{Normal}(y_n|\mu, \sigma) \cdot \mathit{Normal}(\mu | 0, 20) \cdot \mathit{LogNormal}(\sigma | 3, 1)
\tag{10.5}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(y = {-3.376, -0.906, \ldots}\)</span></p>
<p>We can also define the unnormalized posterior, <span class="math inline">\(up(\cdot)\)</span>, as a function in R:</p>
<div class="sourceCode" id="cb608"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb608-1"><a href="ch-introstan.html#cb608-1" aria-hidden="true" tabindex="-1"></a>up <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu, sigma) {</span>
<span id="cb608-2"><a href="ch-introstan.html#cb608-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(<span class="at">x =</span> mu, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">20</span>) <span class="sc">*</span></span>
<span id="cb608-3"><a href="ch-introstan.html#cb608-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dlnorm</span>(<span class="at">x =</span> sigma, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="sc">*</span></span>
<span id="cb608-4"><a href="ch-introstan.html#cb608-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prod</span>(<span class="fu">dnorm</span>(<span class="at">x =</span> y, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma))</span>
<span id="cb608-5"><a href="ch-introstan.html#cb608-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, if we want to know the unnormalized posterior density for the vector of parameters <span class="math inline">\(&lt;\mu,\sigma&gt; = &lt;0, 5&gt;\)</span>, we do the following:</p>
<div class="sourceCode" id="cb609"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb609-1"><a href="ch-introstan.html#cb609-1" aria-hidden="true" tabindex="-1"></a><span class="fu">up</span>(<span class="at">y =</span> Y, <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1] 1.73e-194</code></pre>
<p>The shape of the unnormalized posterior density is completely defined and it will look like Figure <a href="ch-introstan.html#fig:up">10.1</a>.</p>

<div class="figure"><span style="display:block;" id="fig:up"></span>
<img src="bookdown_files/figure-html/up-1.svg" alt="The unnormalized posterior defined by Equation (10.5)" width="672" />
<p class="caption">
FIGURE 10.1: The unnormalized posterior defined by Equation <a href="ch-introstan.html#eq:up">(10.5)</a>
</p>
</div>
<p>Why is the shape of the unnormalized posterior density not enough? The main reason is that unless we already know which probability distribution we are dealing with (e.g., normal, Bernoulli, etc.) or we can easily integrate it (which only happens in a handful of cases) we cannot do much with the analytical form of the unnormalized posterior: We cannot calculate credible intervals, or know how likely it is that the true score is above or below zero, and even the mean of the posterior is impossible to calculate.
This is because the unnormalized posterior distribution represents the general shape of the posterior distribution. With just the shape of an unknown distribution, we can only answer the following question: What is the most (or least) likely value of the vector of parameters? We can answer this question by searching for the highest (or lowest) place in that shape. This leads us to the estimate of the maximum a posteriori (MAP), which is the Bayesian counterpart of the maximum likelihood estimate (MLE). (However, if we can recognize the shape as a distribution, we are in a different situation. In that case, we might know already the formulas for the expectation, variance, etc. This is what we did in chapter <a href="ch-introBDA.html#ch-introBDA">2</a>, but it is an unusual situation in realistic analyses.)
As we mentioned before, if we want to get posterior density values, we need the denominator of the Bayes rule (or marginal likelihood), <span class="math inline">\(p(y)\)</span>, which requires integrating the unnormalized posterior. Even this is not too useful if we want to communicate findings, almost every summary statistic require us to solve more integrals, and except for a handful of cases, these integrals might not have an analytical solution.</p>
<p>As we mentioned before, the only summary that we can get with an unnormalized posterior shape (that we don’t recognize as a familiar distribution) is its mode (or the MAP: the highest point in Figure <a href="ch-introstan.html#fig:up">10.1</a>, or the lowest point of the negative log unnormalized log posterior). However, even calculating the mode is not always trivial. In simple cases as this one, one can calculate it analytically; but in more complex cases relatively complicated algorithms are needed.</p>
<p>If we want to be able to calculate summary statistics of the posterior distribution (mean, quantiles, etc.), we are going to need samples from this distribution. This is because with enough samples of a probability distribution, we can achieve very good approximations of summary statistics. Stan will take care of returning samples from the posterior distribution, if the log unnormalized posterior distribution is differentiable and can be expressed as follows:<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a></p>
<p><span class="math display" id="eq:logup">\[\begin{equation}
\log(up(\Theta|y)) = \sum_n log(p(y_n|\Theta)) + \sum_q log(p(\Theta_q))
\tag{10.6}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(n\)</span> indicates each data point and <span class="math inline">\(q\)</span> each parameter. In our case, this corresponds to the following:</p>
<p><span class="math display" id="eq:up-applied">\[\begin{equation}
\begin{aligned}
\log(up(\mu, \sigma |y)) =&amp; \sum_n^{100} \log(Normal(y_n|\mu, \sigma)) + \log(Normal(\mu | 0, 20)) \\
&amp;+ \log(LogNormal(\sigma | 3, 1))
\end{aligned}
\tag{10.7}
\end{equation}\]</span></p>
<p>In the following sections, we’ll see how we can implement this model and many others in Stan.</p>
<div id="stan-syntax" class="section level2 hasAnchor" number="10.1">
<h2><span class="header-section-number">10.1</span> Stan syntax<a href="ch-introstan.html#stan-syntax" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A Stan program is usually saved as a <code>.stan</code> file and accessed through R (or other interfaces) and it is organized into a sequence of optional and obligatory blocks, which must be written in order. The Stan language is different from R and it is loosely based on C++; one important aspect to pay attention to is that every statement ends in a semi-colon, <code>;</code>. Blocks (<code>{}</code>) do not end in semi-colons. Some functions in Stan are written in the same way as in R (e.g., <code>mean</code>, <code>sum</code>, <code>max</code>, <code>min</code>). But some are different; when in doubt, <a href="https://mc-stan.org/users/documentation/">Stan documentation</a> can be extremely helpful. In addition, the package <code>rstan</code> provides the function <code>lookup()</code> to look up for translations of functions. For example, in <a href="ch-reg.html#sec-logistic">4.3</a>, we saw that the R function <code>plogis()</code> is needed to convert from log-odds to probability space. If we need it in a Stan program, we can look for it in the following way:</p>
<div class="sourceCode" id="cb611"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb611-1"><a href="ch-introstan.html#cb611-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lookup</span>(plogis)</span></code></pre></div>
<pre><code>##       StanFunction                         Arguments ReturnType
## 227      inv_logit                             (T x)          R
## 260  log_inv_logit                             (T x)          R
## 261   logistic_cdf  (reals y, reals mu, reals sigma)       real
## 262 logistic_lccdf (reals y , reals mu, reals sigma)       real
## 263  logistic_lcdf (reals y , reals mu, reals sigma)       real</code></pre>
<p>There are three columns in the output of this call. The first one indicates Stan function names, the second one their arguments with their type, and the third one the type they return. Unlike R, Stan is strict with the type of the variables.<a href="#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a> If we need to decide on the function, we’ll probably need to go to the Stan documentation, and figure out which is the one that matches our specific needs (it would be <code>inv_logit()</code>).</p>
<p>Another important difference with R is that every variable needs to be declared at the beginning of a block with its type (real, integer, vector, matrix, etc.). The next two sections exemplify these details through basic Stan programs.</p>
</div>
<div id="sec-firststan" class="section level2 hasAnchor" number="10.2">
<h2><span class="header-section-number">10.2</span> A first simple example with Stan: Normal likelihood<a href="ch-introstan.html#sec-firststan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s fit a Stan model to estimate the simple example given at the introduction of this chapter, where we simulate data from a normal distribution with a true mean of 3 and a true standard deviation of 10:</p>
<div class="sourceCode" id="cb613"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb613-1"><a href="ch-introstan.html#cb613-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>As we said before Stan code is organized in blocks. The first block indicates what constitutes “data” for the model:</p>
<div class="sourceCode" id="cb614"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb614-1"><a href="ch-introstan.html#cb614-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb614-2"><a href="ch-introstan.html#cb614-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;  <span class="co">// Total number of trials</span></span>
<span id="cb614-3"><a href="ch-introstan.html#cb614-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;  <span class="co">// Score in each trial</span></span>
<span id="cb614-4"><a href="ch-introstan.html#cb614-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The variable of type <code>int</code> (integer) represents the number of trials. In addition to the type, some constraints can be indicated with <code>lower</code> and <code>upper</code>. In this case, <code>N</code> can’t be smaller than <code>1</code>. These constraints serve as a sanity check; if they are not satisfied, we get an error and the model won’t run. The data are stored in a vector of length <code>N</code>, unlike R, vectors (and matrices and arrays) need to be defined with their dimensions. Comments are indicated with <code>//</code> rather than <code>#</code>.</p>
<p>The next block indicates the parameters of the model:</p>
<div class="sourceCode" id="cb615"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb615-1"><a href="ch-introstan.html#cb615-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb615-2"><a href="ch-introstan.html#cb615-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb615-3"><a href="ch-introstan.html#cb615-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb615-4"><a href="ch-introstan.html#cb615-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The two parameters are real numbers, and <code>sigma</code> is constrained to be positive.</p>
<p>Finally, we indicate the prior distributions and likelihood functions in the model block:</p>
<div class="sourceCode" id="cb616"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb616-1"><a href="ch-introstan.html#cb616-1" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb616-2"><a href="ch-introstan.html#cb616-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors:</span></span>
<span id="cb616-3"><a href="ch-introstan.html#cb616-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(mu | <span class="dv">0</span>, <span class="dv">20</span>);</span>
<span id="cb616-4"><a href="ch-introstan.html#cb616-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lognormal_lpdf(sigma | <span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb616-5"><a href="ch-introstan.html#cb616-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood:</span></span>
<span id="cb616-6"><a href="ch-introstan.html#cb616-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N)</span>
<span id="cb616-7"><a href="ch-introstan.html#cb616-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> normal_lpdf(y[i] | mu, sigma);</span>
<span id="cb616-8"><a href="ch-introstan.html#cb616-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The variable <code>target</code> is a reserved word in Stan; every statement with <code>target +=</code> adds terms to the unnormalized <em>log</em> posterior probability. We do this because adding to the unnormalized log posterior means to multiply a term in the numerator of the unnormalized posterior. As we explained before, Stan uses the shape of the unnormalized posterior to sample from the actual posterior distribution. See Box <a href="ch-introstan.html#thm:target">10.1</a> for a more detailed explanation, and see Box <a href="ch-introstan.html#thm:tilde">10.2</a> for alternative notations.</p>
<div class="extra">
<div class="theorem">
<p><span id="thm:target" class="theorem"><strong>Box 10.1  </strong></span><strong>What does <code>target</code> do?</strong></p>
</div>
<p>We can exemplify how <code>target</code> works with one hypothetical iteration of the sampler.</p>
<p>In every iteration where the sampler explores the posterior space, <code>mu</code> and <code>sigma</code> acquire different values (this is where Stan algorithm stops the movement of the particle in the Hamiltonian space). Say that in an iteration, <code>mu = 2.619</code> and <code>sigma = 9.068</code>. Then the following happens in the model block:</p>
<ol style="list-style-type: decimal">
<li>At the beginning of the iteration, <code>target</code> is zero.</li>
<li>The transformations that the sampler <em>automatically</em> does are taken into account. In our case, although <code>sigma</code> is constrained to be positive in our model, inside Stan’s sampler it is transformed to an “unconstrained” space amenable to Hamiltonian Monte Carlo. That is, Stan samples from an auxiliary parameter that ranges from minus infinity to infinity, which is equivalent to <code>log(sigma)</code>. This auxiliary parameter is then exponentiated, when it is incorporated into our model. Because of the mismatch between the constrained parameter space that we defined and the unconstrained space that its converted to by Stan, an adjustment to the unnormalized posterior is required and added <em>automatically</em>. The reasons for this requirement are somewhat complex and will be discussed in section <a href="ch-custom.html#ch-custom">12</a>. In this particular case, this adjustment (which is the log absolute value of the Jacobian determinant), is equivalent to adding <code>log(sigma) = 2.205</code> to <code>target</code>.</li>
<li>After <code>target + = normal_lpdf(mu | 0, 20);</code> the log of the density of <span class="math inline">\(\mathit{Normal}(0,20)\)</span> is evaluated at a given sample of mu (specifically 2.619) and this is added to <code>target</code>. In R, this would be <code>dnorm(x = 2.619, mean = 0, sd = 20, log = TRUE)</code>, which is equal to <code>-3.923</code>. Thus, <code>target</code> should be <code>-3.923 + 2.205 = -1.718</code>.</li>
<li>After <code>target += lognormal_lpdf(sigma | 3, 1)</code>, we add the log of the density of <span class="math inline">\(\mathit{LogNormal}(3, 1)\)</span> evaluated at <code>9.068</code> to the previous value of the target. In R, this would be <code>dlnorm(x = 9.068 , mean = 3, sd = 1, log = TRUE)</code>, which is equal to <code>-3.44</code>. Thus, <code>target</code> should be updated to <code>-1.718 + -3.44 = -5.158</code>.</li>
<li>After each iteration of the for-loop in the model block, we add to the target the log density of <span class="math inline">\(\mathit{Normal}( 2.619, 9.068)\)</span> evaluated at each of the values of Y. In R, this would be to add <code>sum(dnorm(Y, 2.619, 9.068, log = TRUE))</code> (which is equal to <code>-362.147</code>) to the current value of <code>target</code> <code>-5.158 + -362.147 = -367.305</code>.</li>
</ol>
<p>This means that for the coordinates &lt;mu = 2.619, sigma = 9.068&gt;, the height of the unnormalized posterior would be the value <code>exp(target) =</code> <span class="math inline">\(\exp( -367.305 ) = 3.03\times 10^{-160}\)</span>. Incidentally, the value of <code>target</code> is returned as <code>lp__</code> (log probability) in an object storing a fit model with Stan.</p>
<p>It is possible to expose the value of <code>target</code>, by printing <code>target()</code> inside a Stan model. The value of <code>target</code> after each iteration is named <code>lp__</code> in the Stan object. This can be useful to troubleshoot a problematic model.</p>
</div>
<div class="extra">
<div class="theorem">
<p><span id="thm:tilde" class="theorem"><strong>Box 10.2  </strong></span><strong>Explicitly incrementing the log probability function (<code>target</code>) vs. using the sampling (<code>~</code>) notation.</strong></p>
</div>
<p>In this book we specify priors and likelihoods by explicitly incrementing the log-probability function with the following code.</p>
<pre><code>target +=  pdf_name_lpdf(parameter | ...)</code></pre>
<p>However, Stan also allows for specifying priors and likelihood with the so-called sampling notation with the following code.</p>
<pre><code>parameter ~ pdf_name(..)</code></pre>
<p>Confusingly enough a sampling statement does not perform any actual sampling, and it is meant to be a notational convenience.</p>
<p>The following two lines of code lead to the same behavior in Stan with respect to parameter estimation. There is, nonetheless, an important difference between them.</p>
<pre><code>y ~ normal(mu, sigma);
target += normal_lpdf(y | mu, sigma);</code></pre>
<p>The important difference is that sampling notation will <em>drop normalizing constants</em>. Consider the following formula that corresponds to the log-transformed PDF of a normal distribution:</p>
<p><span class="math display">\[\begin{equation}
-log(\sigma) - \frac{log(2 \pi)}{2} - \frac{(y-\mu)^2}{2 \sigma^2}
\end{equation}\]</span></p>
<p>If one uses the sampling notation, Stan will ignore the terms that don’t contain parameters, such as <span class="math inline">\(- \frac{log(2 \pi)}{2}\)</span>, and depending on whether <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\mu\)</span>, and <span class="math inline">\(y\)</span> are data or parameters, Stan will ignore them or not. For example if <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\mu\)</span> are parameters, it means that also <span class="math inline">\(-log(\sigma)\)</span> is a constant term that can be ignored (but not <span class="math inline">\(- \frac{(y-\mu)^2}{2 \sigma^2}\)</span> because it contains the parameter <span class="math inline">\(y\)</span>). Dropping constant terms does not affect parameter estimation because it only affects the unnormalized likelihood in the same way in all the parameter space. To make it more concrete, the whole plot in Figure <a href="ch-introstan.html#fig:up">10.1</a> will move up or down by some constant amount, and this won’t affect the Hamiltionian dynamics that determine how we sample from the posterior.</p>
<p>The advantage of the sampling notation is that it can be faster (when many terms are ignored), but the disadvantage is that (i) it is not compatible with the calculation of Bayes factor with bridge sampling (see section <a href="ch-bf.html#sec-stanBF">15.4</a> in chapter <a href="ch-bf.html#ch-bf">15</a>), or the calculation of the log-likelihood for cross validation (see chapter <a href="ch-cv.html#ch-cv">16</a>), (ii) it misleads us to think that Stan is actually sampling the left term in the sampling statement, e.g., drawing <span class="math inline">\(y\)</span> from a normal distribution in the previous example, when in fact at each step the log-probability (<code>target</code>) is incremented based on the parameter values determined by Hamiltionian dynamics (as it is explained before), and (iii) it makes the transition to more complex models where the sampling notation cannot be used (as in, for example, mixture models in chapter <a href="ch-mixture.html#ch-mixture">19</a>) less straightforward.</p>
<p>If one is not going to use Bayes factor with bridge sampling or cross-validation, the same speed advantage of the sampling notation can also be achieved by incrementing the log-probability with log-unnormalized probability density or mass functions (functions ending with <code>_lupdf</code> or <code>_lupmf</code>). The previous example would be translated into the following:</p>
<pre><code>target += normal_lupdf(y | mu, sigma);</code></pre>
</div>
<p>We didn’t use curly brackets with the for-loop; this is a common practice if the for-loop has only one line, but brackets can be added and are obligatory if the for-loop spans several lines.</p>
<p>It’s also possible to avoid the for-loop since many functions are vectorized in Stan:</p>
<div class="sourceCode" id="cb621"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb621-1"><a href="ch-introstan.html#cb621-1" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb621-2"><a href="ch-introstan.html#cb621-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors:</span></span>
<span id="cb621-3"><a href="ch-introstan.html#cb621-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(mu | <span class="dv">0</span>, <span class="dv">20</span>);</span>
<span id="cb621-4"><a href="ch-introstan.html#cb621-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lognormal_lpdf(sigma | <span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb621-5"><a href="ch-introstan.html#cb621-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood:</span></span>
<span id="cb621-6"><a href="ch-introstan.html#cb621-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(y | mu, sigma);</span>
<span id="cb621-7"><a href="ch-introstan.html#cb621-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The for-loop and vectorized versions are giving us the exact same output: The for-loop version evaluated the log-likelihood at each value of <code>y</code> and added it to <code>target</code>. The vectorized version does not create a vector of log-likelihoods, instead it sums the log-likelihood evaluated at each element of <code>y</code> and then it adds that to <code>target</code>.</p>
<p>The complete model that we will fit looks like this:</p>
<div class="sourceCode" id="cb622"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb622-1"><a href="ch-introstan.html#cb622-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb622-2"><a href="ch-introstan.html#cb622-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;  <span class="co">// Total number of trials</span></span>
<span id="cb622-3"><a href="ch-introstan.html#cb622-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;  <span class="co">// Score in each trial</span></span>
<span id="cb622-4"><a href="ch-introstan.html#cb622-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb622-5"><a href="ch-introstan.html#cb622-5" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb622-6"><a href="ch-introstan.html#cb622-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb622-7"><a href="ch-introstan.html#cb622-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb622-8"><a href="ch-introstan.html#cb622-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb622-9"><a href="ch-introstan.html#cb622-9" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb622-10"><a href="ch-introstan.html#cb622-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors:</span></span>
<span id="cb622-11"><a href="ch-introstan.html#cb622-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(mu | <span class="dv">0</span>, <span class="dv">20</span>);</span>
<span id="cb622-12"><a href="ch-introstan.html#cb622-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lognormal_lpdf(sigma | <span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb622-13"><a href="ch-introstan.html#cb622-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood:</span></span>
<span id="cb622-14"><a href="ch-introstan.html#cb622-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(y | mu, sigma);</span>
<span id="cb622-15"><a href="ch-introstan.html#cb622-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You can save the above code as <code>normal.stan</code>. Alternatively, you can use the version stored in the package <code>bcogsci</code>. (<code>?stan-normal</code> provides some documentation for the model.) You can access the code of the models of this book by using <code>system.file("stan_models", "name_of_the_model.stan", package = "bcogsci")</code>.</p>
<div class="sourceCode" id="cb623"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb623-1"><a href="ch-introstan.html#cb623-1" aria-hidden="true" tabindex="-1"></a>normal <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb623-2"><a href="ch-introstan.html#cb623-2" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;normal.stan&quot;</span>,</span>
<span id="cb623-3"><a href="ch-introstan.html#cb623-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span></code></pre></div>
<p>This command just points to a text file that the package <code>bcogsci</code> stored in your system. You can open it to read the code (with any text editor, or <code>readLines()</code> in R). You’ll need to compile this code and run it with <code>stan()</code>.</p>
<p>Stan requires the data to be in a list object in R. Below we fit the model with the default number of chains and iterations.</p>
<div class="sourceCode" id="cb624"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb624-1"><a href="ch-introstan.html#cb624-1" aria-hidden="true" tabindex="-1"></a>lst_score_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> Y, <span class="at">N =</span> <span class="fu">length</span>(Y))</span>
<span id="cb624-2"><a href="ch-introstan.html#cb624-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model with the default values of number of</span></span>
<span id="cb624-3"><a href="ch-introstan.html#cb624-3" aria-hidden="true" tabindex="-1"></a><span class="co"># chains and iterations: chains = 4, iter = 2000</span></span>
<span id="cb624-4"><a href="ch-introstan.html#cb624-4" aria-hidden="true" tabindex="-1"></a>fit_score <span class="ot">&lt;-</span> <span class="fu">stan</span>(normal, <span class="at">data =</span> lst_score_data)</span>
<span id="cb624-5"><a href="ch-introstan.html#cb624-5" aria-hidden="true" tabindex="-1"></a><span class="co"># alternatively:</span></span>
<span id="cb624-6"><a href="ch-introstan.html#cb624-6" aria-hidden="true" tabindex="-1"></a><span class="co"># stan(&quot;normal.stan&quot;, data = lst_score_data)</span></span></code></pre></div>
<p>We can inspect how well the chains mixed in Figure <a href="ch-introstan.html#fig:traceplotmusigma">10.2</a>. The chains for each parameter should look like a “fat hairy caterpillar” <span class="citation">(<a href="#ref-lunn2012bugs" role="doc-biblioref">D. Lunn et al. 2012</a>)</span>; see section <a href="ch-compbda.html#sec-convergencenut">3.2.1.2</a> for a brief discussion about convergence.</p>

<div class="sourceCode" id="cb625"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb625-1"><a href="ch-introstan.html#cb625-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit_score, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceplotmusigma"></span>
<img src="bookdown_files/figure-html/traceplotmusigma-1.svg" alt="Traceplots of mu and sigma from the model fit_score." width="672" />
<p class="caption">
FIGURE 10.2: Traceplots of <code>mu</code> and <code>sigma</code> from the model <code>fit_score</code>.
</p>
</div>
<p>We can see a summary of the posterior by either printing out the model fit, or by plotting it. The summary displayed by the function <code>print</code> includes means, standard deviations (<code>sd</code>), quantiles, Monte Carlo standard errors for the mean of the posterior (<code>se_mean</code>), split Rhats, and effective sample sizes (<code>n_eff</code>). The summaries are computed after removing the warmup and merging together all chains. The <code>se_mean</code> is unrelated to the <code>se</code> of an estimate in the parallel frequentist model. Similarly to a large effective sample size, small Monte Carlo standard errors indicate an “efficient” sampling procedure: with a large value of <code>n_eff</code> and a small value for <code>se_mean</code> we can be relatively sure of the reliability of the mean of the posterior. However, what constitutes a large or small <code>se_mean</code> is harder to define <span class="citation">(see <a href="#ref-vehtari2019ranknormalization" role="doc-biblioref">Vehtari, Gelman, et al. 2019</a> for a more extensive discussion)</span>.<a href="#fn35" class="footnote-ref" id="fnref35"><sup>35</sup></a></p>
<div class="sourceCode" id="cb626"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb626-1"><a href="ch-introstan.html#cb626-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_score, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##       mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
## mu    3.44    0.01 0.94 1.56 2.84 3.44 4.06  5.27  3916    1
## sigma 9.15    0.01 0.65 8.00 8.69 9.13 9.58 10.50  3057    1
## 
## Samples were drawn using NUTS(diag_e) at Tue Sep  6 12:35:09 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>After transforming the <code>stanfit</code> object into a data frame, it’s possible to provide summary plots as the one shown in <a href="ch-introstan.html#fig:mcmchist">10.3</a>. The package <code>bayesplot</code> <span class="citation">(<a href="#ref-R-bayesplot" role="doc-biblioref">Gabry and Mahr 2019</a>)</span> is a wrapper around <code>ggplot2</code> <span class="citation">(<a href="#ref-R-ggplot2" role="doc-biblioref">Wickham, Chang, et al. 2019</a>)</span> and has several convenient functions to plot the samples. Bayesplot functions for posterior summaries start with <code>mcmc_</code>:</p>

<div class="sourceCode" id="cb628"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb628-1"><a href="ch-introstan.html#cb628-1" aria-hidden="true" tabindex="-1"></a>df_fit_score <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_score)</span>
<span id="cb628-2"><a href="ch-introstan.html#cb628-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_hist</span>(df_fit_score, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:mcmchist"></span>
<img src="bookdown_files/figure-html/mcmchist-1.svg" alt="Histograms of the samples of the posterior distributions of mu and sigma from the model fit_score." width="672" />
<p class="caption">
FIGURE 10.3: Histograms of the samples of the posterior distributions of <code>mu</code> and <code>sigma</code> from the model <code>fit_score</code>.
</p>
</div>
<p>There are also several ways to get the samples for other summaries or customized plots, depending on whether we want a list, a data frame, or an array.</p>
<div class="sourceCode" id="cb629"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb629-1"><a href="ch-introstan.html#cb629-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract from rstan is sometimes overwritten by</span></span>
<span id="cb629-2"><a href="ch-introstan.html#cb629-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a tidyverse version, we make sure that it&#39;s right one:</span></span>
<span id="cb629-3"><a href="ch-introstan.html#cb629-3" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">extract</span>(fit_score) <span class="sc">%&gt;%</span></span>
<span id="cb629-4"><a href="ch-introstan.html#cb629-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code></pre></div>
<pre><code>## List of 3
##  $ mu   : num [1:4000(1d)] 2.62 3.84 2.87 3.73 1.78 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. ..$ iterations: NULL
##  $ sigma: num [1:4000(1d)] 9.07 9.51 8.9 8.2 9.05 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. ..$ iterations: NULL
##  $ lp__ : num [1:4000(1d)] -367 -367 -367 -368 -369 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. ..$ iterations: NULL</code></pre>
<div class="sourceCode" id="cb631"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb631-1"><a href="ch-introstan.html#cb631-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(fit_score) <span class="sc">%&gt;%</span></span>
<span id="cb631-2"><a href="ch-introstan.html#cb631-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(<span class="at">list.len =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    4000 obs. of  3 variables:
##  $ mu   : num  3.5 3.67 3.76 4.3 5.11 ...
##  $ sigma: num  8.85 8.93 10 10.99 8.95 ...
##  $ lp__ : num  -367 -367 -368 -371 -369 ...</code></pre>
<div class="sourceCode" id="cb633"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb633-1"><a href="ch-introstan.html#cb633-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.array</span>(fit_score) <span class="sc">%&gt;%</span></span>
<span id="cb633-2"><a href="ch-introstan.html#cb633-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code></pre></div>
<pre><code>##  num [1:1000, 1:4, 1:3] 3.5 3.67 3.76 4.3 5.11 ...
##  - attr(*, &quot;dimnames&quot;)=List of 3
##   ..$ iterations: NULL
##   ..$ chains    : chr [1:4] &quot;chain:1&quot; &quot;chain:2&quot; &quot;chain:3&quot; &quot;chain:4&quot;
##   ..$ parameters: chr [1:3] &quot;mu&quot; &quot;sigma&quot; &quot;lp__&quot;</code></pre>
<div class="extra">
<div class="theorem">
<p><span id="thm:cmdstanr" class="theorem"><strong>Box 10.3  </strong></span><strong>An alternative R interface to Stan: <code>cmdstanr</code></strong></p>
</div>
<p>For the time being, there are two major nuisances with <code>rstan</code>, (i) the R code interfaces directly with C++ creating installation problems in many systems, (ii) <code>rstan</code> releases lag behind Stan language releases considerably preventing the user from taking advantage from the latest features of Stan. The package <code>cmdstanr</code> (<a href="https://mc-stan.org/cmdstanr/" class="uri">https://mc-stan.org/cmdstanr/</a>) is a lightweight interface to Stan for R that solves these problems.
The downside is that being lightweight some functionality of <code>rstan</code> is (still) lost, such as looking up functions with <code>lookup()</code>, exposing functions with <code>expose_stan_function()</code>, as well as using the fitted model with the <code>bridgesampling</code> package to generate Bayes factors. Furthermore, the package <code>cmdstanr</code> is currently under development and the application programming interface (API) might still change. However, the user interested in an easy (and painless) installation and the latest features of Stan might find it useful.</p>
<p>Once <code>cmdstanr</code> is installed, we can use it as follows:</p>
<p>First create a new <code>CmdStanModel</code> object from a file containing a Stan program using <code>cmdstan_model()</code></p>
<div class="sourceCode" id="cb635"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb635-1"><a href="ch-introstan.html#cb635-1" aria-hidden="true" tabindex="-1"></a>normal <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb635-2"><a href="ch-introstan.html#cb635-2" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;normal.stan&quot;</span>,</span>
<span id="cb635-3"><a href="ch-introstan.html#cb635-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb635-4"><a href="ch-introstan.html#cb635-4" aria-hidden="true" tabindex="-1"></a>normal_mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(normal) </span></code></pre></div>
<p>The object <code>normal_mod</code> is an R6 reference object (<a href="https://r6.r-lib.org/" class="uri">https://r6.r-lib.org/</a>). This class of object behaves similarly to objects in object oriented programming languages, such as python. Methods are accessed using <code>$</code> (rather than <code>.</code> as in python).</p>
<p>To sample, use the <code>$sample()</code> method. The data argument accepts a list (as we used in <code>stan()</code> from <code>rstan</code>). However, many of the arguments of <code>$sample</code> have different names than the ones used in <code>stan()</code> from the <code>rstan</code> package:</p>
<div class="sourceCode" id="cb636"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb636-1"><a href="ch-introstan.html#cb636-1" aria-hidden="true" tabindex="-1"></a>lst_score_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> Y, <span class="at">N =</span> <span class="fu">length</span>(Y))</span>
<span id="cb636-2"><a href="ch-introstan.html#cb636-2" aria-hidden="true" tabindex="-1"></a>fit_normal_cmd <span class="ot">&lt;-</span> normal_mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb636-3"><a href="ch-introstan.html#cb636-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> lst_score_data,</span>
<span id="cb636-4"><a href="ch-introstan.html#cb636-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb636-5"><a href="ch-introstan.html#cb636-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb636-6"><a href="ch-introstan.html#cb636-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb636-7"><a href="ch-introstan.html#cb636-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb636-8"><a href="ch-introstan.html#cb636-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>)</span></code></pre></div>
<p>To show the posterior summary, access the method <code>$summary()</code>of the object <code>fit_normal_cmd</code>.</p>
<div class="sourceCode" id="cb637"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb637-1"><a href="ch-introstan.html#cb637-1" aria-hidden="true" tabindex="-1"></a>fit_normal_cmd<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<p>Access the samples of <code>fit_normal_cmd</code> using <code>$draws()</code>.</p>
<div class="sourceCode" id="cb638"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb638-1"><a href="ch-introstan.html#cb638-1" aria-hidden="true" tabindex="-1"></a>fit_normal_cmd<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">&quot;mu&quot;</span>)</span></code></pre></div>
<p>The vignette of <a href="https://mc-stan.org/cmdstanr/" class="uri">https://mc-stan.org/cmdstanr/</a> shows more use cases, and how the samples can be transformed into other formats (data frame, matrix, etc) together with the package <code>posterior</code> (<a href="https://mc-stan.org/cmdstanr/" class="uri">https://mc-stan.org/cmdstanr/</a>).</p>
</div>
</div>
<div id="sec-clozestan" class="section level2 hasAnchor" number="10.3">
<h2><span class="header-section-number">10.3</span> Another simple example: Cloze probability with Stan with the binomial likelihood<a href="ch-introstan.html#sec-clozestan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s fit a Stan model (<code>binomial_cloze.stan</code>) to estimate the cloze probability of a word given its context: that is, what is the probability of an upcoming word given its previous context; the model that is detailed in <a href="ch-introBDA.html#sec-analytical">2.2</a> and was fit in <a href="ch-compbda.html#sec-sampling">3.1</a>. We want to estimate the cloze probability of <em>“umbrella”</em>, <span class="math inline">\(\theta\)</span>, given the following data: <em>“umbrella”</em> was answered <span class="math inline">\(80\)</span> out of <span class="math inline">\(100\)</span> trials. We assume a binomial distribution as the likelihood function, and <span class="math inline">\(Beta(a=4,b=4)\)</span> as a prior distribution for the cloze probability.</p>
<div class="sourceCode" id="cb639"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb639-1"><a href="ch-introstan.html#cb639-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb639-2"><a href="ch-introstan.html#cb639-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N; <span class="co">// Total number of answers</span></span>
<span id="cb639-3"><a href="ch-introstan.html#cb639-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = N&gt; k; <span class="co">// Number of times umbrella was answered</span></span>
<span id="cb639-4"><a href="ch-introstan.html#cb639-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb639-5"><a href="ch-introstan.html#cb639-5" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb639-6"><a href="ch-introstan.html#cb639-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// theta is a probability, it has to be constrained between 0 and 1</span></span>
<span id="cb639-7"><a href="ch-introstan.html#cb639-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; theta;</span>
<span id="cb639-8"><a href="ch-introstan.html#cb639-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb639-9"><a href="ch-introstan.html#cb639-9" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb639-10"><a href="ch-introstan.html#cb639-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prior on theta:</span></span>
<span id="cb639-11"><a href="ch-introstan.html#cb639-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> beta_lpdf(theta | <span class="dv">4</span>, <span class="dv">4</span>); </span>
<span id="cb639-12"><a href="ch-introstan.html#cb639-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood:</span></span>
<span id="cb639-13"><a href="ch-introstan.html#cb639-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> binomial_lpmf(k | N, theta); </span>
<span id="cb639-14"><a href="ch-introstan.html#cb639-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>There is only one parameter in this model, cloze probability represented with the parameter <code>theta</code>, which is a real number constrained between <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span>. Another difference between this and the previous example is that the likelihood function ends with <code>_lpmf</code> rather than with <code>_lpdf</code>. This is because Stan differentiates between distributions of continuous variables, i.e, probability density functions (PDF), and distributions of discrete variables, i.e., probability mass functions (PMF).</p>
<div class="sourceCode" id="cb640"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb640-1"><a href="ch-introstan.html#cb640-1" aria-hidden="true" tabindex="-1"></a>lst_cloze_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">k =</span> <span class="dv">80</span>, <span class="at">N =</span> <span class="dv">100</span>)</span>
<span id="cb640-2"><a href="ch-introstan.html#cb640-2" aria-hidden="true" tabindex="-1"></a>binomial_cloze <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb640-3"><a href="ch-introstan.html#cb640-3" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;binomial_cloze.stan&quot;</span>,</span>
<span id="cb640-4"><a href="ch-introstan.html#cb640-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb640-5"><a href="ch-introstan.html#cb640-5" aria-hidden="true" tabindex="-1"></a>fit_cloze <span class="ot">&lt;-</span> <span class="fu">stan</span>(binomial_cloze, <span class="at">data =</span> lst_cloze_data)</span></code></pre></div>
<p>We print the summary of the posterior distribution of <span class="math inline">\(\theta\)</span> below, and we show its posterior distribution graphically (see Figure <a href="ch-introstan.html#fig:posttheta">10.4</a>).</p>

<div class="sourceCode" id="cb641"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb641-1"><a href="ch-introstan.html#cb641-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_cloze, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))</span></code></pre></div>
<pre><code>##       mean 2.5% 97.5% n_eff Rhat
## theta 0.78  0.7  0.85  1493    1</code></pre>
<div class="sourceCode" id="cb643"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb643-1"><a href="ch-introstan.html#cb643-1" aria-hidden="true" tabindex="-1"></a>df_fit_cloze <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_cloze)</span>
<span id="cb643-2"><a href="ch-introstan.html#cb643-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens</span>(df_fit_cloze, <span class="at">pars =</span> <span class="st">&quot;theta&quot;</span>) <span class="sc">+</span></span>
<span id="cb643-3"><a href="ch-introstan.html#cb643-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(df_fit_cloze<span class="sc">$</span>theta))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:posttheta"></span>
<img src="bookdown_files/figure-html/posttheta-1.svg" alt="Posterior distribution of the cloze probability of umbrella; parameter \(\theta\)." width="672" />
<p class="caption">
FIGURE 10.4: Posterior distribution of the cloze probability of umbrella; parameter <span class="math inline">\(\theta\)</span>.
</p>
</div>
</div>
<div id="regression-models-in-stan" class="section level2 hasAnchor" number="10.4">
<h2><span class="header-section-number">10.4</span> Regression models in Stan<a href="ch-introstan.html#regression-models-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the following sections, we will revisit and expand on some of the examples that we fit with <code>brms</code> in chapter <a href="ch-reg.html#ch-reg">4</a>.</p>
<div id="sec-pupilstan" class="section level3 hasAnchor" number="10.4.1">
<h3><span class="header-section-number">10.4.1</span> A first linear regression in Stan: Does attentional load affect pupil size?<a href="ch-introstan.html#sec-pupilstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As in section <a href="ch-reg.html#sec-pupil">4.1</a>, we focus on the effect of cognitive load on one subject’s pupil size with a subset of the data of <span class="citation">Wahn et al. (<a href="#ref-wahnPupilSizesScale2016" role="doc-biblioref">2016</a>)</span>. We use the following likelihood and priors. For details about our decision on priors and likelihood, see <a href="ch-reg.html#sec-pupil">4.1</a>.</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
p\_size_n &amp;\sim \mathit{Normal}(\alpha + c\_load_n \cdot \beta,\sigma) \\
\alpha &amp;\sim \mathit{Normal}(1000, 500) \\
\beta &amp;\sim \mathit{Normal}(0, 100) \\
\sigma &amp;\sim \mathit{Normal}_+(0, 1000)
\end{aligned}
\end{equation}\]</span></p>
<p>The Stan model <code>pupil_model.stan</code> follows:</p>
<div class="sourceCode" id="cb644"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb644-1"><a href="ch-introstan.html#cb644-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb644-2"><a href="ch-introstan.html#cb644-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;</span>
<span id="cb644-3"><a href="ch-introstan.html#cb644-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] p_size;</span>
<span id="cb644-4"><a href="ch-introstan.html#cb644-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] c_load;</span>
<span id="cb644-5"><a href="ch-introstan.html#cb644-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb644-6"><a href="ch-introstan.html#cb644-6" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb644-7"><a href="ch-introstan.html#cb644-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb644-8"><a href="ch-introstan.html#cb644-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta;</span>
<span id="cb644-9"><a href="ch-introstan.html#cb644-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb644-10"><a href="ch-introstan.html#cb644-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb644-11"><a href="ch-introstan.html#cb644-11" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb644-12"><a href="ch-introstan.html#cb644-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors:</span></span>
<span id="cb644-13"><a href="ch-introstan.html#cb644-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">1000</span>, <span class="dv">500</span>);</span>
<span id="cb644-14"><a href="ch-introstan.html#cb644-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb644-15"><a href="ch-introstan.html#cb644-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(sigma | <span class="dv">0</span>, <span class="dv">1000</span>)</span>
<span id="cb644-16"><a href="ch-introstan.html#cb644-16" aria-hidden="true" tabindex="-1"></a>    - normal_lccdf(<span class="dv">0</span> | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb644-17"><a href="ch-introstan.html#cb644-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood</span></span>
<span id="cb644-18"><a href="ch-introstan.html#cb644-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(p_size | alpha + c_load * beta, sigma);</span>
<span id="cb644-19"><a href="ch-introstan.html#cb644-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Because we are fitting a regression, we use the location (<span class="math inline">\(\mu\)</span>) of the likelihood function to regress <code>p_size</code> with the following equation <code>alpha + c_load * beta</code>, where both <code>p_size</code> and <code>c_load</code> are vectors defined in the data block. The following line accumulates the log-likelihood of every observation:</p>
<p><code>target += normal_lpdf(p_size | alpha + c_load * beta, sigma);</code></p>
<p>This is equivalent to and slightly faster than the following lines:</p>
<pre><code>for(n in 1:N)
    target += normal_lpdf(p_size[n] | alpha + c_load[n] * beta, sigma);</code></pre>
<p>A statement that requires some explanation is the following:</p>
<pre><code>target += normal_lpdf(sigma | 0, 1000)
    - normal_lccdf(0 | 0, 1000);</code></pre>
<p>As in our original example in <a href="ch-reg.html#sec-pupil">4.1</a>, we are assuming a truncated normal distribution as a prior for <span class="math inline">\(\sigma\)</span>. Not only are we setting a lower boundary to the parameter with <code>lower = 0</code>, but we are also “correcting” its prior distribution by subtracting <code>normal_lccdf(0 | 0, 1000)</code>, where <code>lccdf</code> stands for log complement of a cumulative distribution function. Once we add a lower boundary, the probability mass under half of the “regular” normal distribution should be one, that is, when we integrate from zero (rather than from minus infinity) to infinity. As we saw in Box <a href="ch-reg.html#thm:truncation">4.1</a>, we need to normalize the PDF by dividing it by the difference of its CDF evaluated in the new boundaries (<span class="math inline">\(a = 0\)</span> and <span class="math inline">\(b = \infty\)</span> in our case):</p>
<p><span class="math display" id="eq:truncPDF2">\[\begin{equation}
f_{[a,b]}(x) = \frac{f(x)}{F(b) - F(a)}
\tag{10.8}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(f\)</span> is a PDF and <span class="math inline">\(F\)</span> a CDF.</p>
<p>This equation in log-space is:</p>
<p><span class="math display" id="eq:truncPDF3">\[\begin{equation}
log(f_{[a,b]}(x)) = log(f(x)) - log(F(b) - F(a))
\tag{10.9}
\end{equation}\]</span></p>
<p>In Stan <span class="math inline">\(\log(f(x))\)</span> corresponds to <code>normal_lpdf(x |...)</code>, and <code>log(F(x))</code> to <code>normal_lcdf(x|...)</code>. Because in our example <span class="math inline">\(b=\infty\)</span>, <span class="math inline">\(F(b) = 1\)</span>, we are dealing with the complement of the log CDF evaluated at <span class="math inline">\(a =0\)</span>, <span class="math inline">\(\log(1 - F(0))\)</span>, that is why we use <code>normal_lccdf(0 | ...)</code> (notice the double <code>c</code>).</p>
<p>To be able to fit the model, Stan requires the data to be input as a list: First, load the data and center the dependent variable in a data frame, then create a list, and finally fit the model.</p>
<div class="sourceCode" id="cb647"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb647-1"><a href="ch-introstan.html#cb647-1" aria-hidden="true" tabindex="-1"></a>df_pupil <span class="ot">&lt;-</span> df_pupil <span class="sc">%&gt;%</span></span>
<span id="cb647-2"><a href="ch-introstan.html#cb647-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">c_load =</span> load <span class="sc">-</span> <span class="fu">mean</span>(load))</span></code></pre></div>
<div class="sourceCode" id="cb648"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb648-1"><a href="ch-introstan.html#cb648-1" aria-hidden="true" tabindex="-1"></a>ls_pupil <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb648-2"><a href="ch-introstan.html#cb648-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_size =</span> df_pupil<span class="sc">$</span>p_size,</span>
<span id="cb648-3"><a href="ch-introstan.html#cb648-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_load =</span> df_pupil<span class="sc">$</span>c_load,</span>
<span id="cb648-4"><a href="ch-introstan.html#cb648-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(df_pupil)</span>
<span id="cb648-5"><a href="ch-introstan.html#cb648-5" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb648-6"><a href="ch-introstan.html#cb648-6" aria-hidden="true" tabindex="-1"></a>pupil_model <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb648-7"><a href="ch-introstan.html#cb648-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;pupil_model.stan&quot;</span>,</span>
<span id="cb648-8"><a href="ch-introstan.html#cb648-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span></span>
<span id="cb648-9"><a href="ch-introstan.html#cb648-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb648-10"><a href="ch-introstan.html#cb648-10" aria-hidden="true" tabindex="-1"></a>fit_pupil <span class="ot">&lt;-</span> <span class="fu">stan</span>(pupil_model, <span class="at">data =</span> ls_pupil)</span></code></pre></div>
<p>Check the traceplots in <a href="ch-introstan.html#fig:traceplotreg">10.5</a>.</p>

<div class="sourceCode" id="cb649"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb649-1"><a href="ch-introstan.html#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit_pupil, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceplotreg"></span>
<img src="bookdown_files/figure-html/traceplotreg-1.svg" alt="Traceplots of alpha, beta, and sigma from the model fit_pupil." width="672" />
<p class="caption">
FIGURE 10.5: Traceplots of <code>alpha</code>, <code>beta</code>, and <code>sigma</code> from the model <code>fit_pupil</code>.
</p>
</div>
<p>Examine some summaries of the marginal posterior distributions of the parameters of interest:</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb650-1"><a href="ch-introstan.html#cb650-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_pupil, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>##        mean  2.5% 97.5% n_eff Rhat
## alpha 701.7 663.2 741.9  3574    1
## beta   34.3  10.5  56.9  3517    1
## sigma 128.8 103.0 162.4  2996    1</code></pre>
<p>Plot the posterior distributions in <a href="ch-introstan.html#fig:postreg">10.6</a>.</p>

<div class="sourceCode" id="cb652"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb652-1"><a href="ch-introstan.html#cb652-1" aria-hidden="true" tabindex="-1"></a>df_fit_pupil <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_pupil)</span>
<span id="cb652-2"><a href="ch-introstan.html#cb652-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_hist</span>(fit_pupil, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:postreg"></span>
<img src="bookdown_files/figure-html/postreg-1.svg" alt="Histograms of the posterior samples of alpha, beta, and sigma from the model fit_pupil." width="672" />
<p class="caption">
FIGURE 10.6: Histograms of the posterior samples of <code>alpha</code>, <code>beta</code>, and <code>sigma</code> from the model <code>fit_pupil</code>.
</p>
</div>
<p>If we want to determine how likely it is that the pupil size increased rather than decreased, we can examine the proportion of samples above zero.</p>
<div class="sourceCode" id="cb653"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb653-1"><a href="ch-introstan.html#cb653-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We are using df_fit_pupil and not the &quot;raw&quot; Stanfit object.</span></span>
<span id="cb653-2"><a href="ch-introstan.html#cb653-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(df_fit_pupil<span class="sc">$</span>beta <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 0.996</code></pre>
<p>If we want to generate prior or posterior predictive distributions, we can either create our own functions in R with the <code>purrr</code> function <code>map_dfr</code> (or a for-loop) as we did in section <a href="ch-reg.html#sec-trial">4.2</a> with the function <code>lognormal_model_pred()</code>. Alternatively, we can use the <code>generated quantities</code> block in our model:</p>
<div class="sourceCode" id="cb655"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb655-1"><a href="ch-introstan.html#cb655-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb655-2"><a href="ch-introstan.html#cb655-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;</span>
<span id="cb655-3"><a href="ch-introstan.html#cb655-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] c_load;</span>
<span id="cb655-4"><a href="ch-introstan.html#cb655-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>= <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; onlyprior;</span>
<span id="cb655-5"><a href="ch-introstan.html#cb655-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] p_size;</span>
<span id="cb655-6"><a href="ch-introstan.html#cb655-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb655-7"><a href="ch-introstan.html#cb655-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb655-8"><a href="ch-introstan.html#cb655-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb655-9"><a href="ch-introstan.html#cb655-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta;</span>
<span id="cb655-10"><a href="ch-introstan.html#cb655-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb655-11"><a href="ch-introstan.html#cb655-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb655-12"><a href="ch-introstan.html#cb655-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb655-13"><a href="ch-introstan.html#cb655-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including all constants</span></span>
<span id="cb655-14"><a href="ch-introstan.html#cb655-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">1000</span>, <span class="dv">500</span>);</span>
<span id="cb655-15"><a href="ch-introstan.html#cb655-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb655-16"><a href="ch-introstan.html#cb655-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(sigma | <span class="dv">0</span>, <span class="dv">1000</span>)</span>
<span id="cb655-17"><a href="ch-introstan.html#cb655-17" aria-hidden="true" tabindex="-1"></a>    - normal_lccdf(<span class="dv">0</span> | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb655-18"><a href="ch-introstan.html#cb655-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (!onlyprior)</span>
<span id="cb655-19"><a href="ch-introstan.html#cb655-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> normal_lpdf(p_size | alpha + c_load * beta, sigma);</span>
<span id="cb655-20"><a href="ch-introstan.html#cb655-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb655-21"><a href="ch-introstan.html#cb655-21" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb655-22"><a href="ch-introstan.html#cb655-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> p_size_pred[N];</span>
<span id="cb655-23"><a href="ch-introstan.html#cb655-23" aria-hidden="true" tabindex="-1"></a>  p_size_pred = normal_rng(alpha + c_load * beta, sigma);</span>
<span id="cb655-24"><a href="ch-introstan.html#cb655-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For most of the probability functions, there is a matching pseudorandom number generator (PRNG) with the suffix <code>_rng</code>. Here we are using the vectorized function <code>normal_rng</code>. Once <code>p_size_pred</code> is declared as an array of size <code>N</code>, the following statement generates <span class="math inline">\(N\)</span> predictions (for each iteration of the sampler):</p>
<pre><code>p_size_pred = normal_rng(alpha + c_load * beta, sigma);</code></pre>
<p>At the moment not all the PRNG are vectorized, but the ones that are only allow for arrays and, confusingly enough, not vectors. We define an array by indicating <code>array</code>, between brackets, the length of each dimension, then the type, and finaly the name of the variable. For example to define an array of real numbers with three dimension of length 6, 7, and 10 we write <code>array[6, 7, 10] real var</code>.<a href="#fn36" class="footnote-ref" id="fnref36"><sup>36</sup></a> Vectors and matrices are also valid types for an array. See Box <a href="ch-introstan.html#thm:stancontainers">10.4</a> for more about the difference between arrays and vectors, and other algebra types. We also included a data variable called <code>onlyprior</code>, this is an integer that can only be set to <span class="math inline">\(1\)</span> (TRUE) or <span class="math inline">\(0\)</span> (FALSE). When <code>onlyprior = 1</code>, the likelihood is omitted from the model, <code>p_size</code> is ignored, and <code>p_size_pred</code> is the prior predictive distribution. When <code>onlyprior = 0</code>, the likelihood is incorporated in the model (as it is in the original code <code>pupil_model.stan</code>) using <code>p_size</code>, and <code>p_size_pred</code> is the posterior predictive distribution.</p>
<p>If we want posterior predictive distributions, we fit the model to the data and set <code>onlyprior = 0</code>, if we want prior predictive distributions, we sample from the priors and set <code>onlyprior = 0</code>. Then we use <code>bayesplot</code> functions to visualize predictive checks.</p>
<p>For posterior predictive checks, we would do the following:</p>
<div class="sourceCode" id="cb657"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb657-1"><a href="ch-introstan.html#cb657-1" aria-hidden="true" tabindex="-1"></a>ls_pupil <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb657-2"><a href="ch-introstan.html#cb657-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">onlyprior =</span> <span class="dv">0</span>,</span>
<span id="cb657-3"><a href="ch-introstan.html#cb657-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_size =</span> df_pupil<span class="sc">$</span>p_size,</span>
<span id="cb657-4"><a href="ch-introstan.html#cb657-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_load =</span> df_pupil<span class="sc">$</span>c_load,</span>
<span id="cb657-5"><a href="ch-introstan.html#cb657-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(df_pupil)</span>
<span id="cb657-6"><a href="ch-introstan.html#cb657-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb657-7"><a href="ch-introstan.html#cb657-7" aria-hidden="true" tabindex="-1"></a>pupil_gen <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb657-8"><a href="ch-introstan.html#cb657-8" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;pupil_gen.stan&quot;</span>,</span>
<span id="cb657-9"><a href="ch-introstan.html#cb657-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb657-10"><a href="ch-introstan.html#cb657-10" aria-hidden="true" tabindex="-1"></a>fit_pupil <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">file =</span> pupil_gen, <span class="at">data =</span> ls_pupil)</span></code></pre></div>
<p>Store the predicted pupil sizes in <code>yrep_pupil</code>. This variable contains an <span class="math inline">\(N_{samples} \times N_{observations}\)</span> matrix, that is, each row of the matrix is a draw from the posterior predictive distribution, i.e., a vector with one element for each of the data points in y.</p>
<div class="sourceCode" id="cb658"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb658-1"><a href="ch-introstan.html#cb658-1" aria-hidden="true" tabindex="-1"></a>yrep_pupil <span class="ot">&lt;-</span> <span class="fu">extract</span>(fit_pupil)<span class="sc">$</span>p_size_pred</span>
<span id="cb658-2"><a href="ch-introstan.html#cb658-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(yrep_pupil)</span></code></pre></div>
<pre><code>## [1] 4000   41</code></pre>
<p>Predictive checks functions in <code>bayesplot</code> (starting with <code>ppc_</code>) require a vector with the observations in the first argument and a matrix with the predictive distribution as its second argument. As an example, in Figure <a href="ch-introstan.html#fig:densoverlay">10.7</a> we use an overlay of densities and we draw only <span class="math inline">\(50\)</span> elements (that is <span class="math inline">\(50\)</span> predicted data sets).</p>

<div class="sourceCode" id="cb660"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb660-1"><a href="ch-introstan.html#cb660-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(df_pupil<span class="sc">$</span>p_size, <span class="at">yrep =</span> yrep_pupil[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ])</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:densoverlay"></span>
<img src="bookdown_files/figure-html/densoverlay-1.svg" alt="Posterior predictive check showing 50 predicted density plots from the model fit_pupil against the observed data." width="672" />
<p class="caption">
FIGURE 10.7: Posterior predictive check showing 50 predicted density plots from the model <code>fit_pupil</code> against the observed data.
</p>
</div>
<p>For prior predictive distributions, we simply set <code>onlyprior = 1</code>. The observations (<code>p_size</code>) are ignored by the model, but are required by the data block in Stan. If we haven’t collected data yet, we could include a vector of zeros.</p>
<div class="sourceCode" id="cb661"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb661-1"><a href="ch-introstan.html#cb661-1" aria-hidden="true" tabindex="-1"></a>ls_pupil_prior <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb661-2"><a href="ch-introstan.html#cb661-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">onlyprior =</span> <span class="dv">1</span>,</span>
<span id="cb661-3"><a href="ch-introstan.html#cb661-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_size =</span> df_pupil<span class="sc">$</span>p_size,</span>
<span id="cb661-4"><a href="ch-introstan.html#cb661-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># or: p_size = rep(0, nrow(df_pupil)),</span></span>
<span id="cb661-5"><a href="ch-introstan.html#cb661-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_load =</span> df_pupil<span class="sc">$</span>c_load,</span>
<span id="cb661-6"><a href="ch-introstan.html#cb661-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(df_pupil)</span>
<span id="cb661-7"><a href="ch-introstan.html#cb661-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb661-8"><a href="ch-introstan.html#cb661-8" aria-hidden="true" tabindex="-1"></a>prior_pupil <span class="ot">&lt;-</span> <span class="fu">stan</span>(pupil_gen, <span class="at">data =</span> ls_pupil_prior,</span>
<span id="cb661-9"><a href="ch-introstan.html#cb661-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.9</span>))</span></code></pre></div>
<p>We need to increase the <code>adapt_delta</code> parameter’s default value from <span class="math inline">\(0.8\)</span> to <span class="math inline">\(0.9\)</span> to simulate the data to avoid divergent transitions. It is important to highlight that we cannot safely ignore the warnings of the last model, even if we are not fitting data. This is so because in practice one is still sampling a density using Hamiltonian Monte Carlo, and thus the prior sampling process can break in the same ways as the posterior sampling process. Prior predictive distributions as the one shown in Figure <a href="ch-introstan.html#fig:priordensoverlay">10.8</a> can be plot with <code>ppd_dens_overlay()</code> (and in general with functions starting with <code>ppd_</code> which don’t require an argument with data). <!-- Predictive checks in `bayesplot`, as the one shown in Figure \@ref(fig:priordensoverlay), require (at least for now), an argument `y` with data. If we haven't collected data yet, we can, for example, use it to provide plausible or implausible values that we want to compare to the prior predictive realizations. In the following example, we set `y` to be a uniform distribution that ranges between 0 and 1000; this is the distribution density drawn with the darker color in the plot.  (Alternatively, we can use `ggplot` and manually build the plot.) The uniformly distributed data (the dark line) don't look particularly uniform here; this is because we are simulating only 41 data points.  --></p>

<div class="sourceCode" id="cb662"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb662-1"><a href="ch-introstan.html#cb662-1" aria-hidden="true" tabindex="-1"></a>yrep_prior_pupil <span class="ot">&lt;-</span> <span class="fu">extract</span>(prior_pupil)<span class="sc">$</span>p_size_pred</span>
<span id="cb662-2"><a href="ch-introstan.html#cb662-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ppd_dens_overlay</span>(yrep_prior_pupil[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ])</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:priordensoverlay"></span>
<img src="bookdown_files/figure-html/priordensoverlay-1.svg" alt="Prior predictive distribution showing \(50\) predicted density plots from the model fit_pupil." width="672" />
<p class="caption">
FIGURE 10.8: Prior predictive distribution showing <span class="math inline">\(50\)</span> predicted density plots from the model <code>fit_pupil</code>.
</p>
</div>
<div class="extra">
<div class="theorem">
<p><span id="thm:stancontainers" class="theorem"><strong>Box 10.4  </strong></span><strong>Matrix, vector, or array in Stan?</strong></p>
</div>
<p>Stan contains three basic linear algebra types, <code>vector</code>, <code>row_vector</code>, and <code>matrix</code>. But Stan also allows for building arrays of any dimension from any type of element (integer, real, etc.). This means that there are several ways to define one-dimensional N-sized containers of real numbers,</p>
<pre><code>array[N] real a;
vector[N] a;
row_vector[N] a;</code></pre>
<p>as well as, two-dimensional N1<span class="math inline">\(\times\)</span>N2-sized containers of real numbers:</p>
<pre><code>array[N1, N2] real m;
matrix[N1, N2] m;
array[N1] vector[N2] b;
array[N1] row_vector[N2] b;</code></pre>
<p>These distinctions affect either what we can do with these variables, or the speed of our model, and sometimes are interchangeable. Matrix algebra is only defined for (row) vectors and matrices, that is we cannot multiply arrays. The following line requires all the one-dimensional containers (<code>p_size</code> and <code>c_load</code>) to be defined as vectors (or row_vectors):</p>
<pre><code>vector[N] mu = alpha + c_load * beta;</code></pre>
<p>Many “vectorized” operation are also valid for arrays, that is, <code>normal_lpdf</code>, accepts (row) vectors (as we did in our code) or arrays as in the next example. There is of course no point in converting a vector to an array as follows, but this shows that Stan allows both type of one-dimensional containers.</p>
<pre><code>array[N] real mu = to_array_1d(alpha + c_load * beta);
target += normal_lpdf(p_size | mu, sigma);</code></pre>
<p>By contrast, the outcome of “vectorized” pseudorandom number generator (<code>_rng</code>) functions can only be stored in an array. The following example shows the only way to vectorize this type of function:</p>
<pre><code>array[N] real p_size_pred = normal_rng(alpha + c_load * beta, 
                                       sigma);</code></pre>
<p>Alternatively, one can always use a for-loop, and it won’t matter if <code>p_size_pred</code> is an array or a vector:</p>
<pre><code>vector[N] p_size_pred;
for(n in 1:N)
    p_size_pred[n] = normal_rng(alpha + c_load[n] * beta, sigma);</code></pre>
<p>See also Stan’s manual section on matrices, vector, and arrays <span class="citation">(<a href="#ref-Stan2021" role="doc-biblioref">Stan Development Team 2021</a>)</span>.</p>
</div>
</div>
<div id="sec-interstan" class="section level3 hasAnchor" number="10.4.2">
<h3><span class="header-section-number">10.4.2</span> Interactions in Stan: Does attentional load interact with trial number affecting pupil size?<a href="ch-introstan.html#sec-interstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll expand the previous model to also include the effect of (centered) trial and its interaction with cognitive load on one subject’s pupil size. Our new likelihood will look as follows:</p>
<p><span class="math display">\[\begin{equation}
p\_size_n \sim \mathit{Normal}(\alpha + c\_load_n \cdot \beta_1 + c\_trial \cdot \beta_2 + c\_load \cdot c\_trial \cdot \beta_3, \sigma)
\end{equation}\]</span></p>
<p>Define priors for all the new <span class="math inline">\(\beta\)</span>s. Since we don’t have more information about the new predictors, they are sampled from identical prior distributions:</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\alpha &amp;\sim \mathit{Normal}(1000, 500) \\
\beta_1 &amp;\sim \mathit{Normal}(0, 100) \\
\beta_2 &amp;\sim \mathit{Normal}(0, 100) \\
\beta_3 &amp;\sim \mathit{Normal}(0, 100) \\
\sigma &amp;\sim \mathit{Normal}_+(0, 1000)
\end{aligned}
\end{equation}\]</span></p>
<p>The following Stan model, <code>pupil_int1.stan</code>, is the direct translation of the new priors and likelihood.</p>
<div class="sourceCode" id="cb669"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb669-1"><a href="ch-introstan.html#cb669-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb669-2"><a href="ch-introstan.html#cb669-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;</span>
<span id="cb669-3"><a href="ch-introstan.html#cb669-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] c_load;</span>
<span id="cb669-4"><a href="ch-introstan.html#cb669-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] c_trial;</span>
<span id="cb669-5"><a href="ch-introstan.html#cb669-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] p_size;</span>
<span id="cb669-6"><a href="ch-introstan.html#cb669-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb669-7"><a href="ch-introstan.html#cb669-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb669-8"><a href="ch-introstan.html#cb669-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb669-9"><a href="ch-introstan.html#cb669-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta1;</span>
<span id="cb669-10"><a href="ch-introstan.html#cb669-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta2;</span>
<span id="cb669-11"><a href="ch-introstan.html#cb669-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta3;</span>
<span id="cb669-12"><a href="ch-introstan.html#cb669-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb669-13"><a href="ch-introstan.html#cb669-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb669-14"><a href="ch-introstan.html#cb669-14" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb669-15"><a href="ch-introstan.html#cb669-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including all constants</span></span>
<span id="cb669-16"><a href="ch-introstan.html#cb669-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">1000</span>, <span class="dv">500</span>);</span>
<span id="cb669-17"><a href="ch-introstan.html#cb669-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta1 | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb669-18"><a href="ch-introstan.html#cb669-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta2 | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb669-19"><a href="ch-introstan.html#cb669-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta3 | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb669-20"><a href="ch-introstan.html#cb669-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(sigma | <span class="dv">0</span>, <span class="dv">1000</span>)</span>
<span id="cb669-21"><a href="ch-introstan.html#cb669-21" aria-hidden="true" tabindex="-1"></a>    - normal_lccdf(<span class="dv">0</span> | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb669-22"><a href="ch-introstan.html#cb669-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(p_size | alpha + c_load * beta1 + c_trial * beta2 +</span>
<span id="cb669-23"><a href="ch-introstan.html#cb669-23" aria-hidden="true" tabindex="-1"></a>                        c_load .* c_trial * beta3, sigma);</span>
<span id="cb669-24"><a href="ch-introstan.html#cb669-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>When there are matrices or vectors involved, <code>*</code> indicates matrix multiplication whereas <code>.*</code> indicates element-wise multiplication; in R <code>%*%</code> indicates matrix multiplication whereas <code>*</code> indicates element-wise multiplication.</p>
<p>There is, however, an alternative notation that can simplify our code. In the following likelihood, <span class="math inline">\(p\_size\)</span> is a vector of N observations (in this case 41), <span class="math inline">\(X\)</span> is the model matrix with a dimension of <span class="math inline">\(N \times N_{pred}\)</span> (in this case <span class="math inline">\(41 \times 3\)</span>), and <span class="math inline">\(\beta\)</span> a vector of <span class="math inline">\(N_{pred}\)</span> (in this case, 3) rows. Assuming that <span class="math inline">\(\beta\)</span> is a vector, we indicate with one line that each parameter <span class="math inline">\(\beta_n\)</span> is sampled from identical prior distributions.</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
p\_size &amp;\sim \mathit{Normal}(\alpha + X \cdot \beta,\sigma)\\
\beta &amp;\sim \mathit{Normal}(0, 100) \\
\sigma &amp;\sim \mathit{Normal}_+(0, 1000)
\end{aligned}
\end{equation}\]</span></p>
<p>The translation into Stan code is the following:</p>
<div class="sourceCode" id="cb670"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb670-1"><a href="ch-introstan.html#cb670-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb670-2"><a href="ch-introstan.html#cb670-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;</span>
<span id="cb670-3"><a href="ch-introstan.html#cb670-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; K;   <span class="co">// number of predictors</span></span>
<span id="cb670-4"><a href="ch-introstan.html#cb670-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, K] X;   <span class="co">// model matrix</span></span>
<span id="cb670-5"><a href="ch-introstan.html#cb670-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] p_size;</span>
<span id="cb670-6"><a href="ch-introstan.html#cb670-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb670-7"><a href="ch-introstan.html#cb670-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb670-8"><a href="ch-introstan.html#cb670-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb670-9"><a href="ch-introstan.html#cb670-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[K] beta;</span>
<span id="cb670-10"><a href="ch-introstan.html#cb670-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb670-11"><a href="ch-introstan.html#cb670-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb670-12"><a href="ch-introstan.html#cb670-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb670-13"><a href="ch-introstan.html#cb670-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including all constants</span></span>
<span id="cb670-14"><a href="ch-introstan.html#cb670-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">1000</span>, <span class="dv">500</span>);</span>
<span id="cb670-15"><a href="ch-introstan.html#cb670-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb670-16"><a href="ch-introstan.html#cb670-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(sigma | <span class="dv">0</span>, <span class="dv">1000</span>)</span>
<span id="cb670-17"><a href="ch-introstan.html#cb670-17" aria-hidden="true" tabindex="-1"></a>    - normal_lccdf(<span class="dv">0</span> | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb670-18"><a href="ch-introstan.html#cb670-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(p_size | alpha + X * beta, sigma);</span>
<span id="cb670-19"><a href="ch-introstan.html#cb670-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For some likelihood functions, Stan provides a more efficient implementation of the linear regression than the one manually written in the previous code. It’s critical to understand that, in general, a more efficient implementation should not only be faster, but should also achieve the same number of effective samples (or more) than a less efficient implementation (and should also show convergence). In this case, we can achieve that using <code>_glm</code> functions. We can replace the last line with the following statement (the order of the arguments is important):<a href="#fn37" class="footnote-ref" id="fnref37"><sup>37</sup></a></p>
<pre><code>target += normal_id_glm_lpdf(p_size | X, alpha, beta, sigma);</code></pre>
<p>The most optimized model, <code>pupil_int.stan</code>, includes this last statement. We prepare the data as follows: First create a centered version of trial, <code>c_trial</code> and load <code>c_load</code>, then use the function <code>model.matrix</code> to create the <code>X</code> matrix that contains in each column our predictors and omits the intercept with <code>0 +</code>.</p>
<div class="sourceCode" id="cb672"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb672-1"><a href="ch-introstan.html#cb672-1" aria-hidden="true" tabindex="-1"></a>df_pupil <span class="ot">&lt;-</span> df_pupil <span class="sc">%&gt;%</span></span>
<span id="cb672-2"><a href="ch-introstan.html#cb672-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb672-3"><a href="ch-introstan.html#cb672-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_trial =</span> trial <span class="sc">-</span> <span class="fu">mean</span>(trial),</span>
<span id="cb672-4"><a href="ch-introstan.html#cb672-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_load =</span> load <span class="sc">-</span> <span class="fu">mean</span>(load)</span>
<span id="cb672-5"><a href="ch-introstan.html#cb672-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb672-6"><a href="ch-introstan.html#cb672-6" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> c_load <span class="sc">*</span> c_trial, df_pupil)</span>
<span id="cb672-7"><a href="ch-introstan.html#cb672-7" aria-hidden="true" tabindex="-1"></a>ls_pupil_X <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb672-8"><a href="ch-introstan.html#cb672-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_size =</span> df_pupil<span class="sc">$</span>p_size,</span>
<span id="cb672-9"><a href="ch-introstan.html#cb672-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb672-10"><a href="ch-introstan.html#cb672-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">K =</span> <span class="fu">ncol</span>(X),</span>
<span id="cb672-11"><a href="ch-introstan.html#cb672-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(df_pupil)</span>
<span id="cb672-12"><a href="ch-introstan.html#cb672-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb673"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb673-1"><a href="ch-introstan.html#cb673-1" aria-hidden="true" tabindex="-1"></a>pupil_int <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb673-2"><a href="ch-introstan.html#cb673-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;pupil_int.stan&quot;</span>,</span>
<span id="cb673-3"><a href="ch-introstan.html#cb673-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span></span>
<span id="cb673-4"><a href="ch-introstan.html#cb673-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb673-5"><a href="ch-introstan.html#cb673-5" aria-hidden="true" tabindex="-1"></a>fit_pupil_int <span class="ot">&lt;-</span> <span class="fu">stan</span>(pupil_int, <span class="at">data =</span> ls_pupil_X)</span></code></pre></div>
<div class="sourceCode" id="cb674"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb674-1"><a href="ch-introstan.html#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_pupil_int, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>##           mean   2.5%  97.5% n_eff Rhat
## alpha   699.24 667.24 732.30  5368    1
## beta[1]  31.16  11.21  51.09  4270    1
## beta[2]  -5.83  -8.55  -3.24  4758    1
## beta[3]  -1.83  -3.51  -0.13  4693    1
## sigma   104.17  83.01 131.75  3821    1</code></pre>
<p>In <a href="ch-introstan.html#fig:pupilintbeta">10.9</a>, we plot here the 95% CrI of the parameters of interest. We use <code>regex_pars</code>, rather than <code>pars</code>, because we want to capture <code>beta[1]</code>, <code>beta[2]</code>, and <code>beta[3]</code>; <code>regex_pars</code> use regular expressions to select the parameters (for information about regular expressions in R see <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html" class="uri">https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html</a>)</p>

<div class="sourceCode" id="cb676"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb676-1"><a href="ch-introstan.html#cb676-1" aria-hidden="true" tabindex="-1"></a>df_fit_pupil_int <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_pupil_int)</span>
<span id="cb676-2"><a href="ch-introstan.html#cb676-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit_pupil_int,</span>
<span id="cb676-3"><a href="ch-introstan.html#cb676-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">regex_pars =</span> <span class="st">&quot;beta&quot;</span>,</span>
<span id="cb676-4"><a href="ch-introstan.html#cb676-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_outer =</span> .<span class="dv">95</span>,</span>
<span id="cb676-5"><a href="ch-introstan.html#cb676-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> .<span class="dv">8</span>,</span>
<span id="cb676-6"><a href="ch-introstan.html#cb676-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">point_est =</span> <span class="st">&quot;mean&quot;</span></span>
<span id="cb676-7"><a href="ch-introstan.html#cb676-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:pupilintbeta"></span>
<img src="bookdown_files/figure-html/pupilintbeta-1.svg" alt="95% CrI of the effect of load, beta[1], the effect of trial beta[2], and their interaction beta[3]." width="672" />
<p class="caption">
FIGURE 10.9: 95% CrI of the effect of load, <code>beta[1]</code>, the effect of trial <code>beta[2]</code>, and their interaction <code>beta[3]</code>.
</p>
</div>
</div>
<div id="sec-logisticstan" class="section level3 hasAnchor" number="10.4.3">
<h3><span class="header-section-number">10.4.3</span> Logistic regression in Stan: Does set size and trial affect free recall?<a href="ch-introstan.html#sec-logisticstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We revisit and expand on the analysis presented in <a href="ch-reg.html#sec-logistic">4.3</a> of a subset of the data of <span class="citation">Oberauer (<a href="#ref-oberauerWorkingMemoryCapacity2019" role="doc-biblioref">2019</a>)</span>. In this example, we will investigate whether the length of a list and trial number affect the probability of correctly recalling a word.</p>
<p>As in section <a href="ch-reg.html#sec-logistic">4.3</a>, we assume a Bernoulli likelihood with a logit link function, and the following priors (recall that the logistic function is the inverse of the logit).</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
correct_n &amp;\sim \mathit{Bernoulli}( \mathit{logistic}(\alpha + X \cdot \beta))\\
\alpha &amp;\sim \mathit{Normal}(0, 1.5) \\
\beta &amp;\sim \mathit{Normal}(0, 0.1)
\end{aligned}
\end{equation}\]</span></p>
<p>Where <span class="math inline">\(\beta\)</span> is a vector of size <span class="math inline">\(K = 2\)</span>, <span class="math inline">\(\{\beta_0, \beta_1\}\)</span>. Below in <code>recall.stan</code> we present the most efficient way to code this in Stan.</p>
<div class="sourceCode" id="cb677"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb677-1"><a href="ch-introstan.html#cb677-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb677-2"><a href="ch-introstan.html#cb677-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;</span>
<span id="cb677-3"><a href="ch-introstan.html#cb677-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; K;   <span class="co">// number of predictors</span></span>
<span id="cb677-4"><a href="ch-introstan.html#cb677-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, K] X;   <span class="co">// model matrix</span></span>
<span id="cb677-5"><a href="ch-introstan.html#cb677-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> correct[N];</span>
<span id="cb677-6"><a href="ch-introstan.html#cb677-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb677-7"><a href="ch-introstan.html#cb677-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb677-8"><a href="ch-introstan.html#cb677-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb677-9"><a href="ch-introstan.html#cb677-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[K] beta;</span>
<span id="cb677-10"><a href="ch-introstan.html#cb677-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb677-11"><a href="ch-introstan.html#cb677-11" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb677-12"><a href="ch-introstan.html#cb677-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including all constants</span></span>
<span id="cb677-13"><a href="ch-introstan.html#cb677-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">0</span>, <span class="fl">1.5</span>);</span>
<span id="cb677-14"><a href="ch-introstan.html#cb677-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(beta | <span class="dv">0</span>, .<span class="dv">1</span>);</span>
<span id="cb677-15"><a href="ch-introstan.html#cb677-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> bernoulli_logit_glm_lpmf(correct | X, alpha, beta);</span>
<span id="cb677-16"><a href="ch-introstan.html#cb677-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The dependent variable, <code>correct</code>, is an array of integers rather than a vector; this is because vectors are always composed of real numbers, but the Bernoulli likelihood only accepts the integers <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>. As in the previous example, we are taking advantage of the <code>_glm</code> functions. A less efficient but more transparent option would be to replace the last statement with:</p>
<pre><code>target += bernoulli_logit_lpmf(correct | alpha + X * beta);</code></pre>
<p>We might want to use <code>bernoulli_logit_lpmf</code> if we want to define a non-linear relationship between the predictors that are outside the generalized linear model framework. One example would be the following:</p>
<pre><code>target += bernoulli_logit_lpmf(correct| alpha + exp(X * beta));</code></pre>
<p>Another more flexible possibility when we want to indicate a Bernoulli likelihood is to use <code>bernoulli_lpmf</code> and add the link manually. The last statement of <code>recall.stan</code> would become the following:</p>
<pre><code>target += bernoulli_lpmf(correct| inv_logit(alpha + X * beta));</code></pre>
<p>The function <code>bernoulli_lpmf</code> can be useful if one wants to try other link functions; see exercise <a href="ch-introstan.html#exr:linkfunction">10.4</a>.</p>
<p>Finally, the most transparent form (but less efficient) would be the following for-loop:</p>
<pre><code>for (n in 1:N)
  target += bernoulli_lpmf(correct[n] | inv_logit(alpha + X[n] * beta));</code></pre>
<p>To fit the model as <code>recall.stan</code>, prepare the data by centering the trial number first:</p>
<div class="sourceCode" id="cb682"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb682-1"><a href="ch-introstan.html#cb682-1" aria-hidden="true" tabindex="-1"></a>df_recall <span class="ot">&lt;-</span> df_recall <span class="sc">%&gt;%</span></span>
<span id="cb682-2"><a href="ch-introstan.html#cb682-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">c_set_size =</span> set_size <span class="sc">-</span> <span class="fu">mean</span>(set_size),</span>
<span id="cb682-3"><a href="ch-introstan.html#cb682-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">c_trial =</span> trial <span class="sc">-</span> <span class="fu">mean</span>(trial))</span></code></pre></div>
<p>Next, we create the model matrix, <span class="math inline">\(X\)</span>, and prepare the data as a list. As in section <a href="ch-introstan.html#sec-interstan">10.4.2</a>, we exclude the intercept from the matrix <code>X</code> using <code>0 +...</code>. This is because the Stan code that we are using already takes into account that the first column in the model matrix is going to be a vector of ones.</p>
<div class="sourceCode" id="cb683"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb683-1"><a href="ch-introstan.html#cb683-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> c_set_size <span class="sc">*</span> c_trial, df_recall)</span>
<span id="cb683-2"><a href="ch-introstan.html#cb683-2" aria-hidden="true" tabindex="-1"></a>ls_recall <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb683-3"><a href="ch-introstan.html#cb683-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">correct =</span> df_recall<span class="sc">$</span>correct,</span>
<span id="cb683-4"><a href="ch-introstan.html#cb683-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb683-5"><a href="ch-introstan.html#cb683-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">K =</span> <span class="fu">ncol</span>(X),</span>
<span id="cb683-6"><a href="ch-introstan.html#cb683-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(df_recall)</span>
<span id="cb683-7"><a href="ch-introstan.html#cb683-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb684"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb684-1"><a href="ch-introstan.html#cb684-1" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb684-2"><a href="ch-introstan.html#cb684-2" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;recall.stan&quot;</span>,</span>
<span id="cb684-3"><a href="ch-introstan.html#cb684-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb684-4"><a href="ch-introstan.html#cb684-4" aria-hidden="true" tabindex="-1"></a>fit_recall <span class="ot">&lt;-</span> <span class="fu">stan</span>(recall, <span class="at">data =</span> ls_recall)</span></code></pre></div>
<p>After fitting the model we can print and plot summaries of the posterior distribution.</p>
<div class="sourceCode" id="cb685"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb685-1"><a href="ch-introstan.html#cb685-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_recall, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span></code></pre></div>
<pre><code>##          mean  2.5% 97.5% n_eff Rhat
## alpha    1.98  1.41  2.63  3633    1
## beta[1] -0.19 -0.34 -0.03  3859    1
## beta[2] -0.02 -0.09  0.05  3816    1
## beta[3]  0.00 -0.03  0.04  3802    1</code></pre>
<p>In Figure <a href="ch-introstan.html#fig:cri">10.10</a>, we plot the 95% CrI of the parameters of interest.</p>

<div class="sourceCode" id="cb687"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb687-1"><a href="ch-introstan.html#cb687-1" aria-hidden="true" tabindex="-1"></a>df_fit_recall <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_recall)</span>
<span id="cb687-2"><a href="ch-introstan.html#cb687-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(df_fit_recall,</span>
<span id="cb687-3"><a href="ch-introstan.html#cb687-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">regex_pars =</span> <span class="st">&quot;beta&quot;</span>,</span>
<span id="cb687-4"><a href="ch-introstan.html#cb687-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_outer =</span> .<span class="dv">95</span>,</span>
<span id="cb687-5"><a href="ch-introstan.html#cb687-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> .<span class="dv">8</span>,</span>
<span id="cb687-6"><a href="ch-introstan.html#cb687-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">point_est =</span> <span class="st">&quot;mean&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:cri"></span>
<img src="bookdown_files/figure-html/cri-1.svg" alt="95% credible intervals of the beta parameters of fit_recall model." width="672" />
<p class="caption">
FIGURE 10.10: 95% credible intervals of the <code>beta</code> parameters of <code>fit_recall</code> model.
</p>
</div>
<p>As we did in <a href="ch-reg.html#sec-comlogis">4.3.4</a>, we might want to communicate the posterior in proportions rather than in log-odds (as seen in the parameters <code>beta</code>). We can do this in R manipulating the data frame <code>df_fit_recall</code>, or extracting the samples with <code>extract(fit_recall)</code>. Another alternative presented here is by using the generated quantities block. To make the code more compact we declare the type of each variable and store its content in the same line in <code>recall_prop.stan</code>.</p>
<div class="sourceCode" id="cb688"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb688-1"><a href="ch-introstan.html#cb688-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb688-2"><a href="ch-introstan.html#cb688-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> average_accuracy = inv_logit(alpha);</span>
<span id="cb688-3"><a href="ch-introstan.html#cb688-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[K] change_acc = inv_logit(alpha) - inv_logit(alpha - beta);</span>
<span id="cb688-4"><a href="ch-introstan.html#cb688-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Recall that due to the non-linearity of the scale, the effects depend on the average accuracy, and the set size and trial that we start from (in this case we are examining the change of one unit from the average set size and the average trial).</p>
<div class="sourceCode" id="cb689"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb689-1"><a href="ch-introstan.html#cb689-1" aria-hidden="true" tabindex="-1"></a>recall_prop <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb689-2"><a href="ch-introstan.html#cb689-2" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;recall_prop.stan&quot;</span>,</span>
<span id="cb689-3"><a href="ch-introstan.html#cb689-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb689-4"><a href="ch-introstan.html#cb689-4" aria-hidden="true" tabindex="-1"></a>fit_recall <span class="ot">&lt;-</span> <span class="fu">stan</span>(recall_prop, <span class="at">data =</span> ls_recall)</span></code></pre></div>
<p>The plot in <a href="ch-introstan.html#fig:vaccdet">10.11</a> now shows how the average accuracy deteriorates when the subject is exposed to a set size larger than the average by one, a trial further than the middle one, and the interaction of both.</p>
<div class="sourceCode" id="cb690"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb690-1"><a href="ch-introstan.html#cb690-1" aria-hidden="true" tabindex="-1"></a>df_fit_recall <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit_recall) <span class="sc">%&gt;%</span></span>
<span id="cb690-2"><a href="ch-introstan.html#cb690-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb690-3"><a href="ch-introstan.html#cb690-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">set_size =</span> <span class="st">`</span><span class="at">change_acc[1]</span><span class="st">`</span>,</span>
<span id="cb690-4"><a href="ch-introstan.html#cb690-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trial =</span> <span class="st">`</span><span class="at">change_acc[2]</span><span class="st">`</span>,</span>
<span id="cb690-5"><a href="ch-introstan.html#cb690-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">interaction =</span> <span class="st">`</span><span class="at">change_acc[3]</span><span class="st">`</span></span>
<span id="cb690-6"><a href="ch-introstan.html#cb690-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb690-7"><a href="ch-introstan.html#cb690-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(df_fit_recall,</span>
<span id="cb690-8"><a href="ch-introstan.html#cb690-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;set_size&quot;</span>, <span class="st">&quot;trial&quot;</span>, <span class="st">&quot;interaction&quot;</span>),</span>
<span id="cb690-9"><a href="ch-introstan.html#cb690-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_outer =</span> .<span class="dv">95</span>,</span>
<span id="cb690-10"><a href="ch-introstan.html#cb690-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> .<span class="dv">8</span>,</span>
<span id="cb690-11"><a href="ch-introstan.html#cb690-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">point_est =</span> <span class="st">&quot;mean&quot;</span></span>
<span id="cb690-12"><a href="ch-introstan.html#cb690-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb690-13"><a href="ch-introstan.html#cb690-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Change in accuracy&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:vaccdet"></span>
<img src="bookdown_files/figure-html/vaccdet-1.svg" alt="Effect of set size, trial, and their interaction on the average accuracy of recall." width="672" />
<p class="caption">
FIGURE 10.11: Effect of set size, trial, and their interaction on the average accuracy of recall.
</p>
</div>
<p>The plot in <a href="ch-introstan.html#fig:vaccdet">10.11</a> is showing us that our model is estimating that by increasing the set size by one unit, the recall accuracy of the single subject is deteriorated by 2%. In contrast, there is hardly any trial effect or interaction between trial and set size.</p>
</div>
</div>
<div id="summary-9" class="section level2 hasAnchor" number="10.5">
<h2><span class="header-section-number">10.5</span> Summary<a href="ch-introstan.html#summary-9" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter introduced basic Stan syntax for fitting some standard linear models. Example code covered the normal, binomial, Bernoulli, and log-normal likelihoods. We also saw how to express regression models using the matrix model in Stan syntax.</p>
</div>
<div id="further-reading-7" class="section level2 hasAnchor" number="10.6">
<h2><span class="header-section-number">10.6</span> Further reading<a href="ch-introstan.html#further-reading-7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For further reading on the Hamiltonian Monte Carlo algorithm, see the rather technical review of <span class="citation">Betancourt (<a href="#ref-betancourt2017conceptual" role="doc-biblioref">2017</a>)</span>, or the more conceptual introduction provided by <span class="citation">Monnahan, Thorson, and Branch (<a href="#ref-monnahanFasterEstimationBayesian2017" role="doc-biblioref">2017</a>)</span>. A useful article with example R code is <span class="citation">Neal (<a href="#ref-nealMCMCUsingHamiltonian2011" role="doc-biblioref">2011</a>)</span>. A detailed walk-through on its implementation is also provided in Chapter 41 of <span class="citation">MacKay (<a href="#ref-mackay" role="doc-biblioref">2003</a>)</span>. The Stan documentation is an excellent source for further study (<span class="citation">Stan Development Team (<a href="#ref-Stan2021" role="doc-biblioref">2021</a>)</span>).</p>
</div>
<div id="exercises" class="section level2 hasAnchor" number="10.7">
<h2><span class="header-section-number">10.7</span> Exercises<a href="ch-introstan.html#exercises" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="exercise">
<p><span id="exr:first" class="exercise"><strong>Exercise 10.1  </strong></span>A very simple model.</p>
</div>
<p>In this exercise we revisit the model from <a href="ch-compbda.html#sec-simplenormal">3.2.1</a>. We assume the following:</p>
<ol style="list-style-type: decimal">
<li>There is a true underlying time, <span class="math inline">\(\mu\)</span>, that the subject needs to press the space bar.</li>
<li>There is some noise in this process.</li>
<li>The noise is normally distributed (this assumption is questionable given that response times are generally skewed; we fix this assumption later).</li>
</ol>
<p>That is the likelihood for each observation <span class="math inline">\(n\)</span> will be:</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
rt_n \sim \mathit{Normal}(\mu, \sigma)
\end{aligned}
\end{equation}\]</span></p>
<ol style="list-style-type: lower-alpha">
<li>Decide on <em>appropriate</em> priors and fit this model in Stan. Data can be found in <code>df_spacebar</code></li>
<li>Change the likelihood for a log-normal distribution and change the priors. Fit the model in Stan.</li>
</ol>
<div class="exercise">
<p><span id="exr:badstan" class="exercise"><strong>Exercise 10.2  </strong></span>Incorrect Stan model.</p>
</div>
<p>We want to fit both response times and accuracy with the same model. We simulate the data as follows:</p>
<div class="sourceCode" id="cb691"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb691-1"><a href="ch-introstan.html#cb691-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb691-2"><a href="ch-introstan.html#cb691-2" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb691-3"><a href="ch-introstan.html#cb691-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rt =</span> <span class="fu">rlnorm</span>(N, <span class="at">mean =</span> <span class="dv">6</span>, <span class="at">sd =</span> .<span class="dv">5</span>),</span>
<span id="cb691-4"><a href="ch-introstan.html#cb691-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">correct =</span> <span class="fu">rbern</span>(N, <span class="at">prob =</span> .<span class="dv">85</span>)</span>
<span id="cb691-5"><a href="ch-introstan.html#cb691-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>We build the following model:</p>
<div class="sourceCode" id="cb692"><pre class="sourceCode stan fold-show"><code class="sourceCode stan"><span id="cb692-1"><a href="ch-introstan.html#cb692-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb692-2"><a href="ch-introstan.html#cb692-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; N;</span>
<span id="cb692-3"><a href="ch-introstan.html#cb692-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] rt;</span>
<span id="cb692-4"><a href="ch-introstan.html#cb692-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> correct[N];</span>
<span id="cb692-5"><a href="ch-introstan.html#cb692-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb692-6"><a href="ch-introstan.html#cb692-6" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb692-7"><a href="ch-introstan.html#cb692-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma;</span>
<span id="cb692-8"><a href="ch-introstan.html#cb692-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> theta;</span>
<span id="cb692-9"><a href="ch-introstan.html#cb692-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb692-10"><a href="ch-introstan.html#cb692-10" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb692-11"><a href="ch-introstan.html#cb692-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(mu | <span class="dv">0</span>, <span class="dv">20</span>);</span>
<span id="cb692-12"><a href="ch-introstan.html#cb692-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lognormal_lpdf(sigma | <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb692-13"><a href="ch-introstan.html#cb692-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span>:N)</span>
<span id="cb692-14"><a href="ch-introstan.html#cb692-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> lognormal_lpdf(rt[n] | mu, sigma);</span>
<span id="cb692-15"><a href="ch-introstan.html#cb692-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> bernoulli_lpdf(correct[n] | theta);</span>
<span id="cb692-16"><a href="ch-introstan.html#cb692-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Why is this model not working?</p>
<div class="sourceCode" id="cb693"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb693-1"><a href="ch-introstan.html#cb693-1" aria-hidden="true" tabindex="-1"></a>ls_sim <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb693-2"><a href="ch-introstan.html#cb693-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">rt =</span> df_sim<span class="sc">$</span>rt,</span>
<span id="cb693-3"><a href="ch-introstan.html#cb693-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">correct =</span> df_sim<span class="sc">$</span>correct</span>
<span id="cb693-4"><a href="ch-introstan.html#cb693-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb693-5"><a href="ch-introstan.html#cb693-5" aria-hidden="true" tabindex="-1"></a>incorrect <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;stan_models&quot;</span>, <span class="st">&quot;incorrect.stan&quot;</span>, <span class="at">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb693-6"><a href="ch-introstan.html#cb693-6" aria-hidden="true" tabindex="-1"></a>fit_sim <span class="ot">&lt;-</span> <span class="fu">stan</span>(incorrect, <span class="at">data =</span> ls_sim)</span></code></pre></div>
<pre><code>## Error in stanc(file = file, model_code = model_code, model_name = model_name, : 0
## 
## Syntax error in &#39;string&#39;, line 13, column 2 to column 5, parsing error:
## 
## Ill-formed expression. Expression followed by &quot;;&quot; expected after &quot;target +=&quot;.</code></pre>
<p>Try to make it run. (Hint: There are several problems.)</p>
<div class="exercise">
<p><span id="exr:skewstan" class="exercise"><strong>Exercise 10.3  </strong></span>Using Stan documentation.</p>
</div>
<p>Edit the simple example with Stan from section <a href="ch-introstan.html#sec-firststan">10.2</a>, and replace the normal distribution with a skew normal distribution. (Don’t forget to add a prior to the new parameter, and check Wikipedia and Stan documentation for more information about the distribution).</p>
<p>Fit the following data:</p>
<div class="sourceCode" id="cb695"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb695-1"><a href="ch-introstan.html#cb695-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>Does the estimate of the new parameter make sense?</p>
<div class="exercise">
<p><span id="exr:linkfunction" class="exercise"><strong>Exercise 10.4  </strong></span>The probit link function as an alternative to the logit function.</p>
</div>
<p>The probit link function is the inverse of the CDF of the standard normal distribution (<span class="math inline">\(Normal(0,1)\)</span>). Since the CDF of the standard normal is usually denoted with the Greek letter <span class="math inline">\(\Phi\)</span> (Phi), the probit is denoted as <span class="math inline">\(\Phi^{-1}\)</span>. Refit the model presented in <a href="ch-introstan.html#sec-logisticstan">10.4.3</a> changing the logit link function for the probit link (that is transforming the regression to a constrained space using <code>Phi()</code> in Stan).</p>
<p>You will probably see the following as the model runs; this is because the probit link is less numerically stable (i.e., under and overflows) than the logit link <em>in Stan</em>. Don’t worry, it is good enough for this exercise.</p>
<pre><code>   Rejecting initial value:
   Log probability evaluates to log(0), i.e. negative infinity.
   Stan can&#39;t start sampling from this initial value.</code></pre>
<ol style="list-style-type: lower-alpha">
<li>Do the results change of the coefficients <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> change?</li>
<li>Do the results in probability space change?</li>
</ol>
<div class="exercise">
<p><span id="exr:logisticstan" class="exercise"><strong>Exercise 10.5  </strong></span>Examining the position of the queued word on recall.</p>
</div>
<p>Refit the model presented in <a href="ch-introstan.html#sec-logisticstan">10.4.3</a> and examine whether, set size, trial effects, the position of the queued word (<code>tested</code> in the data set), and their interaction affect free recall. (Tip: You can do this exercise without changing the Stan code.).</p>
<p>How does the accuracy change from position one to position two?</p>
<!-- ex: extra: Another between subjects, RTs: https://www.storre.stir.ac.uk/handle/1893/30411 -->
<!-- ex: extra: For matrix notation interaction -->
<!-- https://journals.sagepub.com/doi/full/10.1177/2515245918810225 -->
<!-- 3. Disfluency engages analytic processing (Alter, Oppenheimer, Epley, & Eyre, 2007, Study 4) -->
<!-- In Study 4, Alter et al. (2007) investigated whether a deliberate, analytic processing style can be activated by incidental disfluency cues that suggest task difficulty. Forty-one subjects attempted to solve syllogisms presented in either a hard-to-read or an easy-to-read font. The hard-to-read font served as an incidental induction of disfluency. Subjects in the hard-to-read-font condition answered more moderately difficult syllogisms correctly (64%) than did subjects in the easy-to-read-font condition (42%), t(39) = 2.01, p = .051, d = 0.63, 95% CI = [−0.004, 1.25]. -->
<div class="exercise">
<p><span id="exr:fallacy" class="exercise"><strong>Exercise 10.6  </strong></span>The conjunction fallacy.</p>
</div>
<p><span class="citation">Paolacci, Chandler, and Ipeirotis (<a href="#ref-Paolaccietal" role="doc-biblioref">2010</a>)</span> examined whether the results of some classic experiments differ between a university pool population and subjects recruited from Mechanical Turk. We’ll examine whether the results of the conjunction fallacy experiment <span class="citation">(or Linda problem: <a href="#ref-TverskyKahneman1983" role="doc-biblioref">Tversky and Kahneman 1983</a>)</span> are replicated for both groups.</p>
<div class="sourceCode" id="cb697"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb697-1"><a href="ch-introstan.html#cb697-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;df_fallacy&quot;</span>)</span>
<span id="cb697-2"><a href="ch-introstan.html#cb697-2" aria-hidden="true" tabindex="-1"></a>df_fallacy</span></code></pre></div>
<pre><code>## # A tibble: 268 × 2
##   source answer
##   &lt;chr&gt;   &lt;int&gt;
## 1 mturk       1
## 2 mturk       1
## 3 mturk       1
## # … with 265 more rows</code></pre>
<p>The conjunction fallacy shows that people often fail to regard a combination of events as less probable than a single event in the combination. <span class="citation">Tversky and Kahneman (<a href="#ref-TverskyKahneman1983" role="doc-biblioref">1983</a>)</span></p>
<p><em>Linda is 31 years old, single, outspoken, and very bright. She majored in philosophy. As a student, she was deeply concerned with issues of discrimination and social justice, and also participated in anti-nuclear demonstrations.</em></p>
<p><em>Which is more probable?</em></p>
<ol style="list-style-type: lower-alpha">
<li><em>Linda is a bank teller.</em></li>
<li><em>Linda is a bank teller and is active in the feminist movement.</em></li>
</ol>
<p>The majority of those asked chose option b. Even if it’s less probably (<span class="math inline">\(\Pr(a \land b)\leq \Pr(b)\)</span> The data set is named <code>df_fallacy</code> and it indicates with <code>0</code> option “a” and with <code>1</code> option <code>b</code>.
Fit a logistic regression in Stan and report:</p>
<ol style="list-style-type: lower-alpha">
<li>The estimated overall probability of answering (b) ignoring the group.</li>
<li>The estimated overall probability of answering (b) for each group.</li>
</ol>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-betancourt2016identifying" class="csl-entry">
Betancourt, Michael J. 2016. <span>“Identifying the Optimal Integration Time in Hamiltonian Monte Carlo.”</span> <a href="https://arxiv.org/abs/1601.00225">https://arxiv.org/abs/1601.00225</a>.
</div>
<div id="ref-betancourt2017conceptual" class="csl-entry">
———. 2017. <span>“A Conceptual Introduction to Hamiltonian Monte Carlo.”</span> <a href="https://arxiv.org/abs/1701.02434">https://arxiv.org/abs/1701.02434</a>.
</div>
<div id="ref-carpenter2017stan" class="csl-entry">
Carpenter, Bob, Andrew Gelman, Matthew D Hoffman, Daniel Lee, Ben Goodrich, Michael J. Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. <span>“Stan: <span>A</span> Probabilistic Programming Language.”</span> <em>Journal of Statistical Software</em> 76 (1).
</div>
<div id="ref-R-bayesplot" class="csl-entry">
Gabry, Jonah, and Tristan Mahr. 2019. <em><span class="nocase">b</span>ayesplot: Plotting for Bayesian Models</em>. <a href="https://CRAN.R-project.org/package=bayesplot">https://CRAN.R-project.org/package=bayesplot</a>.
</div>
<div id="ref-R-rstan" class="csl-entry">
Guo, Jiqiang, Jonah Gabry, and Ben Goodrich. 2019. <em><span class="nocase">r</span>stan: R Interface to Stan</em>. <a href="https://CRAN.R-project.org/package=rstan">https://CRAN.R-project.org/package=rstan</a>.
</div>
<div id="ref-hoffmanNoUTurnSamplerAdaptively2014" class="csl-entry">
Hoffman, Matthew D., and Andrew Gelman. 2014. <span>“The <span>No</span>-<span>U</span>-<span>Turn Sampler</span>: <span>Adaptively</span> Setting Path Lengths in <span>Hamiltonian Monte Carlo</span>.”</span> <em>Journal of Machine Learning Research</em> 15 (1): 1593–623. <a href="http://dl.acm.org/citation.cfm?id=2627435.2638586">http://dl.acm.org/citation.cfm?id=2627435.2638586</a>.
</div>
<div id="ref-lunn2000winbugs" class="csl-entry">
Lunn, D. J., A. Thomas, N. Best, and D. Spiegelhalter. 2000. <span>“<span>WinBUGS</span>-<span>A B</span>ayesian Modelling Framework: <span>C</span>oncepts, Structure, and Extensibility.”</span> <em>Statistics and Computing</em> 10 (4): 325–37.
</div>
<div id="ref-lunn2012bugs" class="csl-entry">
Lunn, David, Chris Jackson, David J Spiegelhalter, Nicky Best, and Andrew Thomas. 2012. <em>The <span>BUGS</span> Book: <span>A</span> Practical Introduction to <span>B</span>ayesian Analysis</em>. Vol. 98. CRC Press.
</div>
<div id="ref-mackay" class="csl-entry">
MacKay, David JC. 2003. <em>Information Theory, Inference and Learning Algorithms</em>. Cambridge, UK: Cambridge University Press.
</div>
<div id="ref-monnahanFasterEstimationBayesian2017" class="csl-entry">
Monnahan, Cole C., James T. Thorson, and Trevor A. Branch. 2017. <span>“Faster Estimation of <span>Bayesian</span> Models in Ecology Using <span>Hamiltonian Monte Carlo</span>.”</span> Edited by Robert B. O’Hara. <em>Methods in Ecology and Evolution</em> 8 (3): 339–48. <a href="https://doi.org/10.1111/2041-210X.12681">https://doi.org/10.1111/2041-210X.12681</a>.
</div>
<div id="ref-nealMCMCUsingHamiltonian2011" class="csl-entry">
———. 2011. <span>“<span>MCMC</span> Using <span>Hamiltonian</span> Dynamics.”</span> In <em>Handbook of Markov Chain Monte Carlo</em>, edited by Steve Brooks, Andrew Gelman, Galin Jones, and Xiao-Li Meng. Taylor &amp; Francis. <a href="https://doi.org/10.1201/b10905-10">https://doi.org/10.1201/b10905-10</a>.
</div>
<div id="ref-oberauerWorkingMemoryCapacity2019" class="csl-entry">
Oberauer, Klaus. 2019. <span>“Working Memory Capacity Limits Memory for Bindings.”</span> <em>Journal of Cognition</em> 2 (1): 40. <a href="https://doi.org/10.5334/joc.86">https://doi.org/10.5334/joc.86</a>.
</div>
<div id="ref-Paolaccietal" class="csl-entry">
Paolacci, Gabriele, Jesse Chandler, and Panagiotis G Ipeirotis. 2010. <span>“Running Experiments on Amazon Mechanical Turk.”</span> <em>Judgment and Decision Making</em> 5 (5): 411–19.
</div>
<div id="ref-plummer2016jags" class="csl-entry">
Plummer, Martin. 2016. <span>“JAGS Version 4.2.0 User Manual.”</span>
</div>
<div id="ref-R-base" class="csl-entry">
R Core Team. 2019. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-Stan2021" class="csl-entry">
Stan Development Team. 2021. <span>“Stan Modeling Language Users Guide and Reference Manual, Version 2.27.”</span> <a href="https://mc-stan.org">https://mc-stan.org</a>.
</div>
<div id="ref-TverskyKahneman1983" class="csl-entry">
Tversky, Amos, and Daniel Kahneman. 1983. <span>“Extensional Versus Intuitive Reasoning: The Conjunction Fallacy in Probability Judgment.”</span> <em>Psychological Review</em> 90 (4): 293.
</div>
<div id="ref-vehtari2019ranknormalization" class="csl-entry">
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and Paul-Christian Bürkner. 2019. <span>“Rank-Normalization, Folding, and Localization: <span>An</span> Improved <span class="math inline">\(\widehat{R}\)</span> for Assessing Convergence of <span>MCMC</span>.”</span> <a href="https://arxiv.org/abs/1903.08008">https://arxiv.org/abs/1903.08008</a>.
</div>
<div id="ref-wahnPupilSizesScale2016" class="csl-entry">
Wahn, Basil, Daniel P. Ferris, W. David Hairston, and Peter König. 2016. <span>“Pupil Sizes Scale with Attentional Load and Task Experience in a Multiple Object Tracking Task.”</span> <em>PLOS ONE</em> 11 (12): e0168087. <a href="https://doi.org/10.1371/journal.pone.0168087">https://doi.org/10.1371/journal.pone.0168087</a>.
</div>
<div id="ref-R-ggplot2" class="csl-entry">
Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, and Hiroaki Yutani. 2019. <em><span class="nocase">g</span>gplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="32">
<li id="fn32"><p>In the specific case of a model with two parameters, e.g., <span class="math inline">\(&lt;\mu,\sigma&gt;\)</span>, the physical analogy works quite well: The <span class="math inline">\(&lt;x,y&gt;\)</span> coordinates of the particle would be determined by <span class="math inline">\(&lt;\mu,\sigma&gt;\)</span>, and its <span class="math inline">\(z\)</span> coordinate would be established by the height of the unnormalized posterior.<a href="ch-introstan.html#fnref32" class="footnote-back">↩︎</a></p></li>
<li id="fn33"><p>Incidentally, this <span class="math inline">\(\log(up(\dot))\)</span> is the variable <code>target</code> in a Stan model and <code>lp__</code> in its output; see Box <a href="ch-introstan.html#thm:target">10.1</a>.<a href="ch-introstan.html#fnref33" class="footnote-back">↩︎</a></p></li>
<li id="fn34"><p>In these output, there are some types that are new to the R user (but they are also used in C++): <code>reals</code> indicates that any of <code>real</code>, <code>real[]</code>, <code>vector</code>, or <code>row_vector</code>. A return type <code>R</code> with an input type <code>T</code> indicates that the type of the output of the function is the same as type of the argument.<a href="ch-introstan.html#fnref34" class="footnote-back">↩︎</a></p></li>
<li id="fn35"><p>We simplify the output of <code>print</code> in the text after this call, by actually calling <code>summary(fit, pars = pars, probs = c(0.025, 0.975))$summary</code>.<a href="ch-introstan.html#fnref35" class="footnote-back">↩︎</a></p></li>
<li id="fn36"><p>The notation for arrays has changed in recent versions, the previous notation would have been <code>real[6, 7, 10] var</code>.<a href="ch-introstan.html#fnref36" class="footnote-back">↩︎</a></p></li>
<li id="fn37"><p>An extra boost in efficiency can be obtained in regular regressions where <code>X</code> and <code>Y</code> are data (rather than parameters as in cases of missing data or measurement error), since this function can be executed on a GPU.<a href="ch-introstan.html#fnref37" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-coding2x2.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-complexstan.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
